# BSTR Analysis {#sec-4_bstr_analysis}

This chapter examines reaction engineering of single, isolated, batch stirred-tank reactors (BSTRs). It examines properties, advantages, and disadvantages of BSTRs, common situations where BSTRs are used, the operation of BSTRs, and qualitative and quantitative analysis of BSTRs. It concludes with examples of response and optimization tasks involving BSTRs. Reactor design involving BSTRs is considered separately in @sec-4_non_continuous_design.

## BSTR Characteristics

The two most important characteristics of a BSTR are that (a) the reacting fluid within it is perfectly mixed, and (b) there is no flow of reagents into or out of a BSTR while it is operating, that is, during reaction. As the name batch *stirred tank* reactor suggests, the most common physical form of a BSTR for chemical processing is a stirred tank. As indicated in the schematic representations in @fig-bstr_heat_exchange_schematics, they are typically cylindrical in shape, completely containing the reacting fluid (indicated by blue shading) within rigid walls. When processing liquids, there may be some space at the top of the reactor that does not contain reacting fluid. This is referred to as headspace; it is indicated by gray shading in figure. There must be some means of thoroughly and rapidly mixing the reacting fluid. Commonly an agitator is immersed in the reacting fluid for this purpose.

::: {#fig-bstr_heat_exchange_schematics layout-ncol=3}

![a](Graphics/Batch_with_jacket.png){width="40%"}

![b](Graphics/Batch_with_Coil.png){width="40%"}

![c](Graphics/Batch_with_External_Heat_Exchange.png){width="55%"}

Schematic representations of three batch stirred tank reactors, wherein heat is exchanged with an external fluid through the walls of (a) a jacket, (b) a submerged coil, and (c) an external heat exchanger.
:::

If it is necessary to heat or cool the reactor, a heat exchange fluid (indicated by yellow shading in the figure) may flow in and out of the the reactor during operation, but the heat exchange fluid is physically separated from the reacting fluid. @fig-bstr_heat_exchange_schematics depicts three common configurations for exchange of heat with an external fluid. One (a in the figure) is referred to as a shell or jacket. It is a compartment that surrounds the reacting fluid and has an external heat exchange fluid flowing through it. Another (b in the figure) consists of a coil of tubing that is submerged in the reacting fluid. The heat exchange fluid flows within the coil. The third (c in the figure) is an external heat exchanger. With the latter configuration it is important that the reacting fluid circulates through the heat exchanger rapidly so that the assumption of perfect mixing of the reacting fluid is satisfied. In all three configurations, it is possible that the exchange fluid temperature is not uniform. Nonetheless, in *Reaction Engineering Basics* it is always assumed that the heat exchange fluid (within the shell, coil or external heat exchanger) is perfectly mixed.

Stirred tanks are not often used for the processing of gases or when a solid catalyst is being used because stirring gases or small solids particles is difficult. However, configurations different from a stirred tank can be modeled as BSTRs as long as the critical assumptions are met (perfect mixing and no reagent flow in or out of the reactor). @sec-6_bstr_data_analysis describes a few laboratory BSTRs that are not stirred tanks. Similarly, any reactor in a chemical processing facility that conforms to the assumptions used when deriving the BSTR design equations can be modeled as a BSTR. Heat can be added or removed from a reactor in ways that do not involve an exchange fluid. For example, an electric resistance heating element might be used to add heat. *Reaction Engineering Basics* only considers heat transfer to or from a perfectly mixed heat exchange fluid.

There are **advantages to using a BSTR**, as opposed to the other types of ideal reactors, particularly the flow reactors (CSTRs and PFRs). BSTRs offer flexibility both in terms of the reactions being run and in the details of operating the process. In a situation where the demand for products is too small to warrant continuous production, a batch reactor might be used to make one product for a few weeks, and then be used to make a different product for the next few weeks. This kind of flexibility avoids having the reactor sit idle for extended periods of time. Similarly, if the production of a product involves heating to and holding at two or more different temperatures during processing, it may be easier to produce it in a batch reactor than to set up a chain of continuous reactors operating at the necessary temperatures. Similarly, if the addition of one reagent needs to be delayed, it *may* be possible to do so using a BSTR as described below under BSTR Operation. Again, this may be preferred over two continuous reactors operating in series with that reagent added to the second reactor. In contrast to PFRs, a much broader range of heat transfer area per volume of reacting fluid is possible. Even after the reactor has been constructed, the length of a submerged coil or the area of an external heat exchanger can be altered if additional heat transfer capability is needed.

There are also **disadvantages to using BSTRs**. As described below, the operation of a BSTR includes periods of time during which no reaction is taking place. Compared to reactors like CSTRs and PFRs that run continuously, this can lead to a lower net rate of production. Additionally, the operation of a BSTR is more labor intensive than operation of a continuous reactor. This adds to the cost of production, meaning a higher selling price is necessary in order to make a profit. Another issue with batch processes is that of batch-to-batch consistency. As an example, consider the batch production of an expensive perfume. It is critically important that every batch smells the same. Consequently, in addition to being labor intensive, batch processing requires well-trained operators who are careful to precisely follow the specified operational procedure and not deviate from it. Food and beverage production similarly demand high batch-to-batch consistency. This can be even more challenging if, as an example, the process utilizes agricultural reagents that can vary from season to season or year to year.

In light of their advantages and disadvantages, **BSTRs are often used to produce value-added products**. These are products for which the market demand is smaller, but the price, and therefore the profit per pound, is greater. This is in contrast to commodity products where the demand for large quantities is high, but the price per pound is relatively small. High volume production is usually performed in a continuous reactor (CSTR or PFR).

## BSTR Operation

By its nature, there are times during which reaction is not taking place in a batch reactor. Before reaction can take place, the reactor must first be cleaned (or, in some cases, sterilized) to remove anything “left behind” by the last reaction that was run. Then the reactants must be prepared and charged into the reactor. From this point on, the operation is much like a cooking recipe. A prescribed series of heating and cooling steps is followed, with reaction taking place during every step. A simple example might be that after the reactants are charged, the reactor is heated to a specified temperature, held at that temperature for a specified length of time, and then cooled back to room temperature. In almost all situations, the reaction has ceased by the end of the last step, either because one of the reactants has been fully consumed or because the temperature has been lowered to the point where the rate is effectively zero. The last step in the operating protocol then is to remove the product from the reactor. Often it is transferred to a holding tank from which it can be sent elsewhere for further processing, purification, or longer term storage.

Of course, the operational protocol, i. e. the “recipe,” could be more complicated, requiring any number of steps (also called stages). In some cases an intermediate stage in the operational protocol might call for the addition of a reagent. As long as that reagent is added instantaneously, the reactor can be analyzed as a BSTR. However, if the reagent is added over time as reactions continue to occur, the reactor is no longer a BSTR and that phase of processing must be analyzed as a semi-batch reactor (@sec-4_sbstr_analysis).

It is very important to recognize that the productivity of the reactor, that is the amount of product it produces per hour, must be calculated taking the so-called *turnaround time* into account. That is, one must include the time needed to clean, fill and drain the reactor, not just the length of time during which reaction takes place. Doing so permits the definition of the net rate of generation of reagent $i$ given in @eq-bstr_net_rate.

$$
r_{i,net} = \frac{n_i - n_{i,0}}{t_{rxn} + t_{turn}}
$$ {#eq-bstr_net_rate}

Even if the turnaround time was zero, it would still be desirable to define a net rate as above. The net rate is useful for characterizing the overall process. As the reaction is progressing, the rate of reaction is continually changing because the temperature and composition are changing. The rate of reaction at any one time during the processing is referred to as the instantaneous rate at that time. The net rate defined in @eq-bstr_net_rate is a kind of average of the instantaneous rate over the processing time. Similarly, it is sometimes useful to differentiate between overall and instantaneous values of other quantities such as yields, conversions, selectivities, etc.

## Qualitative Analysis of Reaction in a BSTR

A simple process for the qualitative analysis of a reacting system was presented in @sec-4_response_opt_design. In a BSTR, there are no spatial variations in temperature or composition because the reactor is perfectly mixed. Therefore, qualitative analysis of a BSTR is used to determine how temperature, reaction rate, composition and related quantities (conversion, selectivity) vary with reaction time. 

For purposes of illustration, suppose the typical, irreversible, exothermic reaction, $A \rightarrow Z$ takes place in an isothermal BSTR. In this situation, only the concentrations need to be considered because in an isothermal reactor the temperature does not change. At the start of the process, the concentration of A will be high and that of Z will be small or zero. During a very small interval of time at the start of the process the concentration of A will decrease and the concentration of Z will increase due to the reaction starting to take place. Hence, in a plot of the concentration of reactant A versus reaction time, the $y$-intercept will be high and the slope at that point will be negative. For the product, Z, the $y$-intercept will be low or zero and the initial slope will be positive.

The changes in composition will affect the reaction rate. For a typical, irreversible reaction, the decrease in the reactant concentration will tend to decrease the rate while the increase in the product concentration will not affect it. Consequently, at the end of that small interval of reaction time, the rate will be smaller.

In the next small interval of time, the concentration of the reactant, A, will decrease by less than it did in the first interval because the rate is lower. For the same reason, the concentration of the product, Z, will increase by less than it did during the first interval of time. In terms of graphs showing the concentrations versus time, the concentration of the reactant, A, will start high with a negative slope and a curvature that is concave upward. That is, the slope will become less steep as the reaction time increases. In like manner, a graph showing the concentration of Z versus reaction time will start at or near zero with a positive slope and a curvature that is concave downward (i. e. the slope again will get less steep as the reaction time increases).

If that initial behavior continued throughout the process, the concentration of the reactant would decrease with a smaller and smaller slope until finally reaching a horizontal plateau at a value of zero (because the reaction is irreversible and therefor goes to completion). The concentration of the product would increase with a smaller and smaller slope until finally reaching a plateau at a value equal to the initial concentration of A (because in the reaction being considered, the stoichiometry is 1 Z per A). The results of this qualitative analysis are shown in @fig-qualitative_iso_batch_profiles. Qualitative analysis is not limited to reagent concentrations. Graphs showing conversion, selectivity, rate, temperature, etc. *vs*. time can also be generated.

::: {#fig-qualitative_iso_batch_profiles layout-ncol=2}

![](Graphics/qual_iso_batch_reactant_profile.png){width="80%"}

![](Graphics/qual_iso_batch_product_profile.png){width="80%"}

Qualitative reactant (left) and product (right) concentration profiles during isothermal reaction in a BSTR.
:::

The qualitative analysis here was straightforward because the reactor was isothermal. In [Example -@sec-example_9_6_1] the qualitative analysis of an adiabatic BSTR is presented. That analysis is more complicated because both concentrations and temperature are changing. In fact, the changes in composition and temperature, taken separately, would affect the rate in opposite ways. As a consequence there is greater uncertainty in the qualitative analysis results.

## BSTR Design Equations

The reactor design equations for BSTRs are derived in @sec-apndx_ideal_reactor_models and discussed in @sec-3_design_eqns. The BSTR mole and energy balances shown below were presented in Equations [-@eq-bstr_mole_balance] and [-@eq-bstr_energy_balance]. @sec-3_design_eqns also presented the energy balances shown below for a heat exchange fluid that transfers sensible heat, @eq-exchange_energy_bal_sensible, and one that transfers latent heat, @eq-exchange_energy_bal_latent. That chapter also describes how to select the specific reactor design equations needed to model BSTRs under different circumstances. That discussion will not be duplicated here.

$$
\frac{dn_i}{dt} = V \sum_j \nu_{i,j}r_j
$$

$$
\left(\sum_i n_i \hat C_{p,i} \right) \frac{dT}{dt} - V\frac{dP}{dt}  - P  \frac{dV}{dt}  = \dot Q - \dot W - V \sum_j \left(r_j \Delta H_j \right)
$$

$$
\rho_{ex} V_{ex} \tilde C_{p,ex}\frac{dT_{ex}}{dt} = -\dot Q - \dot m_{ex} \int_{T_{ex,in}}^{T_{ex}} \tilde C_{p,ex}dT
$$

$$
\frac{\rho_{ex} V_{ex} \Delta H_{\text{latent},ex}^0}{M_{ex}} \frac{d \gamma}{dt} = - \dot Q - \gamma \dot m_{ex} \frac{\Delta H_{\text{latent},ex}^0}{M_{ex}}
$$

The design equations can often be simplified. As noted in @sec-3_design_eqns, if the reactor walls are rigid (or if an ideal, incompressible liquid is being processed) then the volume, $V$, will be constant and its time derivative, $\frac{dV}{dt}$, will equal zero. If the work associated with agitation is negligible (it usually is) and there are no other shafts or moving boundaries, then the rate at which the reacting fluid performs work, $\dot W$, on its surroundings is also equal to zero. When an ideal, incompressible liquid is being processed, the pressure, $P$, is constant and its time derivative, $\frac{dP}{dt}$, is equal to zero. (The pressure gradient within the reacting fluid due to the hydrostatic head is neglibible.) Finally, for liquids, @eq-bstr_equivalent_sens_heat_terms showed how the sensible heat term in @eq-bstr_energy_balance can be expressed in terms of the mass-specific or volume-specific heat capacity of the solution as a whole instead of the individual molar heat capacities.

$$
\left(\sum_i n_i \hat C_{p,i} \right) \frac{dT}{dt}\ \Leftrightarrow\ \rho V \tilde C_p \frac{dT}{dt}\ \Leftrightarrow\ V \breve C_p \frac{dT}{dt}
$$

When rate expressions are substituted into the BSTR mole and energy balances, they typically introduce concentrations or partial pressures of reagents. When the design equations are solved, those concentrations and partial pressures must be expressed in terms of the molar amounts of the reagents (see @sec-apndx_solve_ivodes). The concentration is simply the molar amount divided by the volume, @eq-concentration_closed.

$$
C_i = \frac{n_i}{V}
$$

For ideal gases, the partial pressure is related to the molar amount through the ideal gas law, @eq-partial_pressure.

$$
P_i = \frac{n_iRT}{V}
$$

When heat transfer involves an exchange fluid as shown in @fig-bstr_heat_exchange_schematics, the rate of heat exchange in the energy balances can be calculated using @eq-bstr_heat_transfer. If the reactor operates adiabatically (i. e. it is perfectly insulated and does not have a shell, coil or external heat exchanger), $\dot{Q}$ is equal to zero.

$$
\dot Q = UA\left( T_{ex} - T \right)
$$

## General Approach to Modeling Isolated BSTRs

@sec-4_response_opt_design described how to identify a reaction engineering assignment that involves the modeling of an isolated ideal reactor, and @sec-3_reactor_model_func suggested a four step approach to reactor analysis.

1. Summarize the information provided in the assignment.
2. Formulate the solution mathematically.
3. Implement the solution numerically.
4. Report and comment upon the results.

This section describes the application of that approach to the modeling of an isolated BSTR. The process may seem a bit abstract when first read, but it should become clearer after seeing it used in the examples provided at the end of this chapter.

Often the operational protocol for a BSTR has multiple heating and cooling stages. When this is true, each stage of the protocol *may* need to be analyzed separately from the other stages because terms in the reactor design equations may change. The reactor design equations for BSTRs are initial value ordinary differential equations (IVODEs) with elapsed time, $t$, as the independent variable. The stages occur sequentially, and consequently the values of $t$ and the dependent variables at the end of one stage in the operating protocol become the initial values for the next stage. The one exception to this is if a reagent is *instantaneously* added at the end of a stage. In that situation, the initial values for the next stage are the result of mixing the added reagent with the reagents in the BSTR at the end of the previous stage.

**Summarizing the information provided in the assignment**. An assignment summary is useful in that it extracts the critical information from the assignment narrative and presents it as a concise summary. A procedure for creating an assignment summary is presented in @sec-3_reactor_model_func. There are three components in the assignment summary: a list of all known and given constants with the variable symbols being used to represent them, a description of the reactor and its operation, and a list of the quantities of interest indicating the variable symbols being used to represent them. When analyzing a BSTR, the second component will indicate the number of stages in the operational protocol and whether the BSTR is isothermal, adiabatic, heated, or cooled in those stages.

**Formulating the solution mathematically**. For an assignment involving the analysis of a BSTR, it will *always* be necessary to write the reactor design equations that are needed to model that specific BSTR. Selecting which equations are needed to model a given BSTR and simplifying those design equations was described in @sec-3_design_eqns and in the preceding section of this chapter.

As noted above, the design equations for an isolated BSTR will be a set of IVODEs with $t$ as the independent variable. The dependent variables will always include the molar amounts of the reagents present in the system, $n_i$. Depending which other design equation are needed to model the BSTR, the dependent variables may also include the temperature of the reacting fluid, $T$, its pressure, $P$, and either the outlet temperature of the exchange fluid, $T_{ex}$, or the fraction of the exchange fluid that undergoes phase change, $\gamma$.

If the reacting fluid is an ideal gas and the reactor design equations include an energy balance on the reacting fluid, the temperature and the pressure will appear as a dependent variables. Consequently, the number of dependent variables will be one greater than the number of IVODEs. In this situation either a dependent variable must be eliminated from the design equations or another IVODE must be added to them (@sec-apndx_solve_ivodes). A differential form of the ideal gas law, @eq-differential_ideal_gas_law, is used to accomplish that. For a BSTR, $V$ is constant so its time derivative is zero, and does not appear in the differential form of the gas law. The differential ideal gas law can either be added to the reactor design equations, making the number of equations equal to the number of dependent variables, or it can be solved for $\frac{dP}{dt}$, substituting the result into the energy balance and thereby eliminating $P$ as a dependent variable. Both of these approaches are illustrated in @sec-example_9_6_3.

$$
RT\left( \sum_i \frac{dn_i}{dt} \right) + R\left( \sum_i n_i \right)\frac{dT}{dt} - V \frac{dP}{dt} = 0
$$

Once all of the reactor design equations have been written a table presenting the initial values and stopping criterion can be created. For the first stage of the operational protocol, the initial value of $t$ should be 0.0. The other initial values and the known final value should be indicated using the same variable symbol as that used in the assignment summary. If an initial or final value is not known, an appropriate variable symbol should be chosen to represent it.

The next sections of the mathematical formulation consist of ancillary equations of three types. Before the BSTR reactor design equations can be solved, unknown constants and variables appearing in them, other than $t$ and the dependent variables, must be eliminated. Equations that can be used to calculate the unknown constants and extra variables are the first kind of ancillary equations.

The second set of ancillary equations are those that are needed to calculate the numerical value of any initial or final values that are unknown. The third set of ancillary equations are those that are needed to calculate quantities of interest other than those found by solving the BSTR design equations. (Solving the reactor design equations only yields values of the molar amounts, the temperature, the pressure, and either the exchange fluid temperature of the fraction of the exchange fluid that condenses.)

The mathematical formulation concludes with a succinct description of to use the equations to calculate quantities that will be needed during the numerical solution of the IVODE reactor design equations. For each quantity it states the variables that are available for use and describes which equations are used to calculate it.

**Implementing the solution numerically**. The numerical implementation of the solution parallels the mathematical formulation, translating it from mathematical terms to computer code. In *Reaction Engineering Basics* the numerical implementation describes the code in general terms without reference to any one software package or programming language. Sufficient details are provided to enable readers to implement the solution numerically using whatever software they choose. Familiarity with the numerical solution of IVODEs at the level of @sec-apndx_solve_ivodes is assumed.

**Reporting and discussing the results** is straightforward and does not require exposition here.

## Examples

```{r}
#| echo: false
#| output: false
library(tidyverse)
library(knitr)
library(kableExtra)
source('~/Libraries/R/fmt_tibble_col.R')
```


The examples in this section illustrate the analysis of isolated BSTRs. Examples [-@sec-example_9_6_1] and [-@sec-example_9_6_2] are **response assignments** where the assignment specifies a sufficient number of quantities so that the reactor design equations can be solved to find the quantities of interest. In [Example -@sec-example_9_6_1] all necessary reactor inputs and process parameters are specified and the quantities of interest are related to reactor outputs. In [Example -@sec-example_9_6_2] two reactor outputs are specified (the reaction time and the conversion), and one of the unknown quantities of interest is a reactor input (the initial temperature). In addition to illustrating the computational procedure for these two types of response tasks, [Example -@sec-example_9_6_1] involves a single reaction taking place in an adiabatic BSTR while [Example -@sec-example_9_6_2] features two reactions taking place in a BSTR that is cooled using an exchange fluid. Examples [-@sec-example_9_6_3] and [-@sec-example_9_6_4] are **optimization assignments** that identify a reactor variable that must be maximized or minimized by specifying a reactor input. The BSTR operational protocol in [Example -@sec-example_9_6_3], like those in Examples [-@sec-example_9_6_1] and [-@sec-example_9_6_2], consists of a single stage. [Example -@sec-example_9_6_4] illustrates a situation where there are multiple stages in the operating protocol. It also considers turnaround time and the net rate of reaction.


### Concentration, Temperature and Rate Profiles during Adiabatic Operation of a BSTR {#sec-example_9_6_1}

{{< include problem_statements/reb_9_6_1.qmd >}}

---

:::{.callout-tip collapse="true"}

## Click Here to See What an Expert Might be Thinking at this Point

This assignment describes a single BSTR and no other equipment. The rate expression for the reaction taking place in the reactor is provided, and the quantities of interest are reactor variables. I know from @sec-4_response_opt_design that this combination of characteristics identifies this as an isolated ideal reactor modeling assignment.

Following the general approach presented in this chapter, I'll start by summarizing the given quantities, the reactor type and operation, and the quantities of interest. I will use appropriate variable symbols for each quantity, e. g. $n$ for molar amounts, $T$ for temperatures, etc. For quantities that are initial values, I will add a subscripted "0" and for final values I will add a subscripted "f".

:::

#### Assignment Summary

**Given and Known Constants**: $\Delta H_1$ = -101.2 kJ mol^-1^, $k_{0,1}$ = 5.11 x 10^4^ L mol^-1^ s^-1^, $E_1$ = 74.8 kJ mol^-1^, $V$ = 1900 L, $T_0$ = (180 + 273.15) K, $C_{A,0}$ = 2.9 mol L^-1^, $C_{B,0}$ = 3.2 mol L^-1^, $\tilde{C}_p$ = 1.23 cal g^-1^ K^-1^, $\rho$ = 1.02 g cm^-3^, $t_f$ = 2 h, and $R$ = 8.314 J mol^-1^ K^-1^.

**Reactor System**: Adiabatic BSTR with a 1-stage operational protocol.

**Quantities of Interest**: $C_A\left(t\right)$, $C_B\left(t\right)$, $C_Y\left(t\right)$, $C_Z\left(t\right)$, $T\left(t\right)$, and $r\left(t\right)$ as graphs.

#### Mathematical Formulation of the Solution

:::{.callout-tip collapse="true"}

## Click Here to See What an Expert Might be Thinking at this Point

Reactor analysis always requires a set of reactor design equations. The selection of the specific design equations for a given analysis was described in @sec-3_design_eqns. Mole balances are always needed. I'll write a BSTR mole balance, @eq-bstr_mole_balance, each of the reagents. In this assignment, only one reaction is taking place, so the summation reduces to a single term.

$$
\frac{dn_i}{dt} = V \sum_j \nu_{i,j}r_j \qquad \Rightarrow \qquad \frac{dn_i}{dt} = V \nu_i r
$$

This BSTR is not isothermal, so he mole balances cannot be solved independently of an energy balance on the reacting fluid, @eq-bstr_energy_balance. In this assignment the reacting fluid is a liquid which I will assume to be an incompressible ideal solution. Consequently, the reacting fluid volume and the total pressure are constant, and their time derivatives are equal to zero. The reactor is adiabatic, so the rate of heat input, $\dot{Q}$, is equal to zero. There are no shafts or moving boundaries other than the agitator, and the rate at which it performs work is negligible, so $\dot{W}$ is also equal to zero. With only one reaction taking place, the summation over the reactions reduces to a single term. This assignment provides the mass-specific heat capacity of the entire solution, so the sensible heat term can be re-written using that heat capacity, @eq-bstr_equivalent_sens_heat_terms. Finally, the energy balance can be put in the form of a derivative expression by dividing both sides by $\rho V \tilde{C}_p$.

$$
\cancelto{\rho V \tilde{C}_p}{\left(\sum_i n_i \hat C_{p,i} \right)} \frac{dT}{dt} - \cancelto{0}{V\frac{dP}{dt}}  - \cancelto{0}{P\frac{dV}{dt}}  = \cancelto{0}{\dot Q} - \cancelto{0}{\dot W} - V \cancelto{r \Delta H}{\sum_j \left(r_j \Delta H_j \right)}
$$

$$
\rho V \tilde{C}_p \frac{dT}{dt} = - V r_1 \Delta H_1
$$

$$
\frac{dT}{dt} = -\frac{V r_1 \Delta H_1}{\rho V \tilde{C}_p}
$$

In this assignment the BSTR operates adiabatically, so there isn't an exchange fluid, and an exchange fluid energy balance cannot be written. Momentum balances are not used with stirred tank reactors, so for this reactor the design equation consist of mole balances on A, B, Y, and Z and an energy balance on the reacting fluid.

:::

**Reactor Design Equations**

Mole balance design equations for A, B, Y, and Z are presented in equations (3) through (6), and the energy balance on the reacting fluid is given by equation (7).

$$
\frac{dn_A}{dt} = -r_1V \tag{3}
$$

$$
\frac{dn_B}{dt} = -r_1V \tag{4}
$$

$$
\frac{dn_Y}{dt} = r_1V \tag{5}
$$

$$
\frac{dn_Z}{dt} = r_1V \tag{6}
$$

$$
\frac{dT}{dt} = -\frac{r_1 \Delta H_1}{\rho \tilde{C}_p} \tag{7}
$$

:::{.callout-tip collapse="true"}

## Click Here to See What an Expert Might be Thinking at this Point

The independent variable in the BSTR design equations is $t$ and the dependent variables are $n_A$, $n_B$, $n_Y$, $n_Z$, and $T$. There are five IVODEs and five dependent variables, so it is not necessary to add any IVODEs or eliminate any dependent variables.

Being IVODEs, when the design equations are solved numerically the values of the derivatives will need to be calculated at the start of each integration step. At that point, $t$ and the dependent variables, $n_A$, $n_B$, $n_Y$, $n_Z$, and $T$ will be known and all of the given and known constants will be available. Any other quantities appearing in the design equations will need to be calculated in order to evaluate the derivatives (equations (3) - (7)).

The only other variable in equations (3) - (7) is $r_1$. The assignment provides the rate expression, equation (2), which can be used to calculate $r_!$. However, $r_1$ contains the rate coefficient, $k_1$, and the concentrations of A and B. They will need to be calculated before $r_!$ can be calculated. The rate coefficient can be calculated using the Arrhenius expression, @eq-arrhenius. The defining equation for concentration in a closed system, @eq-concentration_closed, can be used to do so.

:::

**Ancillary Equations for Calculating the Derivatives**

The rate, $r_1$ appearing in the reactor design equations can be calculated using the given rate expression, equation (2). The rate coefficient, $k_1$, appearing in equation (2) can be calculated using the Arrhenius expression, equation (8). The concentrations can be calculated using equations (9) and (10).

$$
k = k_{0,1}\exp{\left( \frac{-E_1}{RT} \right)} \tag{8}
$$

$$
C_A = \frac{n_A}{V} \tag{9}
$$

$$
C_B = \frac{n_B}{V} \tag{10}
$$

:::{.callout-tip collapse="true"}

## Click Here to See What an Expert Might be Thinking at this Point

To solve IVODEs numerically, initial values and a stopping criterion are needed. The instant at which the two solutions are charged into the reactor can be defined as $t=0$. The initial values are then the molar amounts of the reagents and the temperature at that isntant. The two solutions that were charged to the BSTR did not contain reagent Y or reagent Z, so their initial amounts are zero. The final value of the time in this assignment is 2 h, which I represented as $t_f$ in the list of known constants. Consequently the stopping criterion is that $t=t_f$.

:::

**Intial Values and Stopping Criterion**

The initial values and stopping criterion for solving the BSTR design equations are shown in @tbl-example_9_6_1_initial_values.

| Variable | Initial Value | Stopping Criterion |
|:------:|:-------:|:-------:|
| $t$ | $0$ | $t_f$ |
| $n_A$ | $n_{A,0}$ | |
| $n_B$ | $n_{B,0}$ | |
| $n_Y$ | $0$ | |
| $n_Z$ | $0$ | |
| $T$ | $T_0$ | |
  
: Initial values and stopping criterion for solving the design equations, equations (3) through (7). {#tbl-example_9_6_1_initial_values}

:::{.callout-tip collapse="true"}

## Click Here to See What an Expert Might be Thinking at this Point

In addition to needing to evaluate the derivatives during numerical solution of IVODEs, the initial and final values must calculated if they are not given and known. Looking at @tbl-example_9_6_1_initial_values, and checking the the given and known constants in the assignment summary shows that the initial values, $n_{A,0}$ and $n_{B,0}$ are not known. The assignment does provide the initial *concentrations* of A and B and the fluid volume, so again, I can calculate the initial molar amounts using the defining equation for concentration.

:::

**Ancillary Equations for Calculating the Initial and Final Values**

The initial molar amounts of A and B in @tbl-example_9_6_1_initial_values can be calculated using equations (11) and (12).

$$
n_{A,0} = C_{A,0}V \tag{11}
$$

$$
n_{B,0} = C_{B,0}V \tag{12}
$$

:::{.callout-tip collapse="true"}

## Click Here to See What an Expert Might be Thinking at this Point

At this point the IVODEs can be solved for $n_A\left(t\right)$, $n_B\left(t\right)$, $n_Y\left(t\right)$, $n_Z\left(t\right)$, and $T\left(t\right)$ in the range from $t=0$ to $t=t_f$. Only one of those results, $T\left(t\right)$ is a quantity of interest. All the other quantities of interest still need to be calculated. Yet again, the defining equation for concentration can be used to calculate the concentrations. The instantaneous rate can then be calculated using the rate expression.

:::

**Ancillary Equations for Calculating Other Quantities of Interest**

With the information given above, equations (3) through (7) can be solved for $n_A\left(t\right)$, $n_B\left(t\right)$, $n_Y\left(t\right)$, $n_Z\left(t\right)$, and $T\left(t\right)$ in the range from $t=0$ to $t=t_f$. The concentrations of A, B, Y, and Z, at each time can then be calculated using equations (9), (10), (13), and (14). Then, knowing $C_A\left(t\right)$, $C_B\left(t\right)$, and $T\left(t\right)$, at each time, the instantaeous rate in that range can be calculated using the Arrhenius expression, equation (8), and the rate expression, equation (2).

$$
C_Y = \frac{n_Y}{V} \tag{13}
$$

$$
C_Z = \frac{n_B}{V} \tag{14}
$$

**Calculations Summary**

1. Substitute the given and known constants into all equations.
2. To calculate the rate, $r_1$, knowing $n_A$, $n_B$ and $T$
	a. calculate $k_1$, $C_A$ and $C_B$ using equations (8), (9), and (10) and then
	b. calculate $r_1$ using equation (2).
3. To calculate $n_{A,0}$ and $n_{B,0}$ use equations (11) and (12).
4. To calculate $C_A$, $C_B$, $C_Y$, and $C_Z$ at any $t$, knowing $n_A$, $n_B$, $n_Y$ and $n_Z$ at that time use equations (9), (10), (13) and (14).
5. To calculate $r_1$ at any $t$ knowing $C_A$, $C_B$, and $T$ at that time
	a. calculate $k_1$ at that time using equation (8) and then
	b. calculate $r$ at that time using equation (2).

#### Numerical Implementation of the Solution

:::{.callout-tip collapse="true"}

## Click Here to See What an Expert Might be Thinking at this Point

The design equations are IVODEs and can be solved as described in @sec-apndx_solve_ivodes. The IVODEs were written in the form of derivative expressions, so no additional equations are needed for writing the derivatives function.

:::

1. Make the given and known constants available for use in all equations.
2. Write a derivatives function that 
    a. receives $t$, $n_A$, $n_B$, $n_Y$, $n_Z$, and $T$, as arguments,
    b. calculates $r_1$ (step 2 in the calculations summary), and
    d. evaluates and returns the derivatives using equations (3) through (7).
3. Write a reactor model function that
	a. calculates $n_{A,0}$ and $n_{B,0}$ (step 3 in the calculations summary),
	b. calls an IVODE solver using the following arguments
		i. the initial values and the stopping criterion in @tbl-example_9_6_1_initial_values and
		ii. the name of the derivatives function from step 2,
	c. checks that the solver sucessfully solved the IVODEs, and
	d. returns sets of corresponding values of $t$, $n_A$, $n_B$, $n_Y$, $n_Z$, and $T$ that span the range from their initial value to their final value.
4. Complete the analysis by
	a. calling the reactor model function from step 3 to get sets of values of $t$, $n_A$, $n_B$, $n_Y$, $n_Z$, and $T$,
	b. calculating corresponding values of $C_A$, $C_B$, $C_Y$, and $C_Z$ (step 4 in the calculations summary),
	c. calculating corresponding values of $r_1$ (step 5 in the calculations summary), and
	d. generating the requested graphs.

#### Results and Discussion

The calculations were performed as described above. The variation of concentrations of reagents, A, B, Y, and Z, during the first two hours of operation of the BSTR are shown in  @fig-example_9_6_1_concentrations. The variation of the reacting fluid temperature during that period is shown in @fig-example_9_6_1_temperatures, and the variation of the instantaneous rate is shown in @fig-example_9_6_1_rates.

![Concentrations *versus* reaction time.](results/reb_9_6_1_concentrations.png){#fig-example_9_6_1_concentrations width="60%"}

![Temperature *versus* reaction time.](results/reb_9_6_1_temperature.png){#fig-example_9_6_1_temperatures width="60%"}

![Rate *versus* reaction time.](results/reb_9_6_1_rate.png){#fig-example_9_6_1_rates width="60%"}

The concentrations of the reactants, A and B, decrease monotonically during the first two hours of operation while the concentrations of the products, Y and Z, increase. The temperature increases steadily, too. The variation of the reaction rate is different. Initially it increases, but then it passes through a maximum after which it steadily decreases.

**Qualitative Analysis**

A qualitative analysis shows that the variations in the concentrations, temperature and rate seen in Figures [-@fig-example_9_6_1_concentrations], [-@fig-example_9_6_1_temperatures], and [-@fig-example_9_6_1_rates] are expected. At $t=0$, the concentrations of the reagents and the temperature are all at their initial values. At this point the rate has the corresponding value calculated using equations (8), (9), (10), and (2).

The rate is positive, so *after a short interval of time* the concentrations of A and B will have decreased slightly and the concentrations of Y and Z will have increased slightly due to the occurrence of the reaction. Because the reaction is exothermic and the reactor operates adiabatically, the temperature will have increased due to the heat released by the reaction.

The rate could either increase or decrease during this short interval. The concentrations of the reactants, A and B, are decreasing, and this alone would cause the rate to decrease. However, at the same time the temperature is increasing, and that alone would cause the rate to increase. Generally, at the start of the reaction the exponential dependence of the rate upon the temperature will be stronger than its dependence upon the reactant concentrations, and the rate will increase. This is seen to be the case in @fig-example_9_6_1_rates. (Had the heat of reaction been very small, leading to a small increase in the temperature, it is possible that the rate would have decreased, especially if the activation was also small).

To summarize, *during that initial short interval of time*, the concentrations of Y and Z, the temperature, and the rate all have positive slopes while the concentrations of A and B have negative slopes. During the *next* short interval of time, the rate is larger than during the first interval of time. As a consequence, the concentrations and temperature will change more during the second interval. That means that the curvature of the temperature, Y concentration, and Z concentration profiles is initially concave upward and the curvature of the A and B concentration profiles is initially concave downward. Again during this second short interval, opposing effects on the rate are associated with the decreasing reactant concentrations and the increasing temperature.

It is hard to see in @fig-example_9_6_1_concentrations and @fig-example_9_6_1_temperatures, but because initially the rate is increasing, the concentrations of A and B are decreasing faster and faster and the concentrations of Y and Z and the temperature are increasing faster and faster. These trends cannot continue indefinitely, if they did, $C_Y$, $C_Z$, and $T$ would approach positive infinity and $C_A$ and $C_B$ would approach negative infinity.

In fact, the curvature does change because *at some point the effect of decreasing reactant concentrations upon the rate becomes stronger than the effect of increasing temperature*. At the point where the two effects become equal, the rate reaches a maximum. Beyond the maximum, the effect of decreasing reactant concentration dominates and the rate decreases. This is seen in @fig-example_9_6_1_rates where the instantaneous rate passes through a maximum.

At the point where the rate reaches its maximum value, the concentration and temperature profiles exhibit an inflection point. (Again, in this example this is very, very subtle and cannot be discerned in the figures.) Beyond that point, the $C_Y$, $C_Z$, and $T$ profiles are concave downward and the $C_A$ and $C_B$ are concave upward. That is, the changes over time become smaller and smaller. This behavior can continue indefinitely. Eventually the concentrations and temperature will stop changing and become constant. In this example, A is the limiting reactant, and the reaction is irreversible, so the concentrations and temperature will become constant when $C_A$ becomes equal to zero.

<!--
:::{.callout-note collapse="false"}
## Note

Videos showing how to complete this assignment using either Matlab or Python, along with the Matlab and Python code, are available in [SCoRE](URL)

:::
-->

### Parallel Reaction Selectivity in a Cooled BSTR with an Unknown Initial Temperature {#sec-example_9_6_2}

{{< include problem_statements/reb_9_6_2.qmd >}}

---

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

This is an isolated reactor modeling assignment: the system consists of only a reactor, it's operation is described, the rate expressions are known and it asks about reactor inputs and outputs. I'll begin by summarizing the assignment. I'll use appropriate variable symbols to represent the given constants. For initial values I'll add a subscripted "0" and for final values a subscripted "f". I'll denote the temperature of the cooling water in the jacked as $T_{ex}$. Thus, $T_{ex,0}$ is the initial temperature of the cooling water in the jacket. Unlike the reactants, cooling water flows into the jacket continuously, so I'll use $T_{ex,in}$ to represent the temperature of the cooling water entering the jacket.

:::

#### Assignment Summary

**Given and Known Constants**: $V$ = 10 L, $V_{ex}$ = 1.4 L, $U$ = 138 cal ft^-2^ min^-1^ K^-1^, $A$ = 1200 cm^2^, $T_{ex,in}$ = 40 °C, $\dot{m}_{ex}$ = 100 g min^-1^, $\rho$ = 1.0 g cm^-3^, $\rho_{ex}$ = 1.0 g cm^-3^, $\tilde{C}_p$ = 1.0 cal g^-1^ K^-1^, $\tilde{C}_{p,ex}$ = 1.0 cal g^-1^ K^-1^, $C_{A,0}$ = 5.0 M, $C_{B,0}$ = 7.0 M, $T_{ex,0}$ = 40 °C, $\Delta H_1$ = -16.7 kcal mol^-1^, $\Delta H_2$ = -14.3 kcal mol^-1^, $k_{0,1}$ = 9.74 x 10^9^ L mol^-1^ min^-1^, $E_1$ = 20.1 kcal mol^-1^, $k_{0,2}$ = 2.38 x 10^13^ min^-1^, $E_2$ = 25.3 kcal mol^-1^, $f_{A,f}$ = 0.45, $t_f$ = 30 min, and $R$ = 1.987 cal mol^-1^ K^-1^.

**Reactor System**: Cooled BSTR with a 1-stage operating protocol.

**Quantities of Interest**: $T_0 : f_A \big \vert_{t=tf} = f_{A,f}$, $T_f$, $T_{ex,f}$, and $S_{X/Z,f}$

#### Mathematical Formulation of the Solution

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The first thing I need to do is generate the reactor design equations for this reactor. Mole balances are always needed, and for a BSTR the mole balance is @eq-bstr_mole_balance. In this system, there are two reactions taking place, so the summation expands to two terms.

$$
\frac{dn_i}{dt} = V \sum_j \nu_{i,j}r_j = \nu_{i,1}r_1V + \nu_{i,2}r_2V
$$

The BSTR is not isothermal, so an energy balance on the reacting fluid, @eq-bstr_energy_balance, is required. There are no shafts or moving boundaries (other than the agitator which is assumed to do negligible work), so the rate of doing work, $\dot{W}$, is zero. The reacting fluid is a liquid, so the pressure is constant and its time-derivative is zero. Assuming it to be an incompressible ideal mixture means that the volume also is constant, and the time-derivative of the volume is equal to zero. The assignment provides a mass-specific heat capacity, so the sensible heat term can be written in terms of that instead of molar heat capacities. Since there are two reactions, the final summation expands to two terms. After making all those substitutions, both sides of the the reacting fluid energy balance can be divided by $\rho V \tilde{C}_p$ to put it in the form of a derivative expression.

$$
\cancelto{\rho V \tilde{C}_p}{\left(\sum_i n_i \hat C_{p,i} \right)} \frac{dT}{dt} - \cancelto{0}{V\frac{dP}{dt}}  - \cancelto{0}{P  \frac{dV}{dt}}  = \dot Q - \cancelto{0}{\dot W} - V \cancelto{\left(r_1 \Delta H_1 +  r_2 \Delta H_2\right)}{\sum_j \left(r_j \Delta H_j \right)}
$$

$$
\rho V \tilde{C}_p \frac{dT}{dt} = \dot Q - V \left(r_1 \Delta H_1 +  r_2 \Delta H_2\right)
$$

The reactor is cooled with chilled water which gains sensible heat from the reacting fluid, so an energy balance on that exchange fluid is necessary and is given by @eq-exchange_energy_bal_sensible.

$$
\rho_{ex} V_{ex} \tilde C_{p,ex}\frac{dT_{ex}}{dt} = -\dot Q - \dot m_{ex} \int_{T_{ex,in}}^{T_{ex}} \tilde C_{p,ex}dT
$$

The exchange fluid heat capacity is constant, making the evaluation of the integral trivial. Dividing both sides of the exchange fluid energy balance by $\rho_{ex} V_{ex} \tilde C_{p,ex}$ then puts it in the form of a derivative expression.

$$
\dot m_{ex}\int_{T_{ex,in}}^{T_{ex}} \tilde C_{p,ex}dT \Rightarrow \dot m_{ex}\tilde C_{p,ex}\left( T_{ex} - T_{ex,in} \right)
$$

Momentum balances are not used with BSTRS so the full set of design equations consists of mole balances on each of the reagents, A, B, X, Y, and Z, an energy balance on the reacting fluid, and an energy balance on the exchange fluid.

:::

**Reactor Design Equations**

Mole balance design equations for A, B, X, Y, and Z are presented in equations (5) through (9). An energy balance on the reacting fluid is given by equation (10), and an energy balance on the exchange fluid is given by equation (11).

$$
\frac{dn_A}{dt} = \left(-r_1 -r_2 \right)V \tag{5}
$$

$$
\frac{dn_B}{dt} = -r_1 V \tag{6}
$$

$$
\frac{dn_X}{dt} = r_1 V \tag{7}
$$

$$
\frac{dn_Y}{dt} = r_1 V \tag{8}
$$

$$
\frac{dn_Z}{dt} = r_2 V \tag{9}
$$

$$
\frac{dT}{dt}  = \frac{\dot Q - V \left(r_1 \Delta H_1 +  r_2 \Delta H_2\right)}{\tilde{C}_p \rho V} \tag{10}
$$

$$
\frac{dT_{ex}}{dt} = \frac{-\dot Q - \dot m_{ex} \tilde C_{p,ex}\left(T_{ex} - T_{ex,in}\right)}{\rho_{ex} V_{ex} \tilde C_{p,ex}} \tag{11}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The reactor design equations are a set of seven IVODEs. The independent variable is $t$ and the dependent variables are $n_A$, $n_B$, $n_X$, $n_Y$, $n_Z$, $T$, and $T_{ex}$. There are seven IVODEs and seven dependent variables, so it is not necessary to add an IVODE or eliminate a dependent variable.

The reactor design equations will be solved numerically. In order to do that, it will be necessary to calculate the values of the derivatives at the start of each integration step. At the start of each step $t$, $n_A$, $n_B$, $n_X$, $n_Y$, $n_Z$, $T$, and $T_{ex}$ will all be available as will the known and given constants listed in the assignment summary.

The only other variables that appear in the design equations are $r_1$, $r_2$, and $\dot{Q}$. The two rates, $r_1$ and $r_2$ can be calculated using the rate expressions, equation (3) and (4). The rate expressions contains four additional variables that will need to be calculated, $k_1$, $k_2$, $C_A$ and $C_B$. The coefficients can be calculated using the Arrhenius expression, @eq-arrhenius. The concentrations can be calculated using the defining equation for concentration in a closed system, @eq-concentration_closed.

The rate of heat exchange, $\dot{Q}$, can be calculated using the given heat transfer coefficient, $U$, and heat transfer area, $A$, using @eq-heat-trans-rate.

:::

**Ancillary Equations for Calculating the Derivatives**

$$
k_1 = k_{0,1}\exp{\left( \frac{-E_1}{RT} \right) } \tag{12}
$$

$$
k_2 = k_{0,2}\exp{\left( \frac{-E_2}{RT} \right) } \tag{13}
$$

$$
C_A = \frac{n_A}{V} \tag{14}
$$

$$
C_B = \frac{n_B}{V} \tag{15}
$$

$$
\dot{Q} = UA\left(T_{ex} - T \right) \tag{16}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

Initial values and a stopping ctierion are needed when solving IVODEs numerically. The instant the fluids are mixed in the reactor can be defined as $t=0$. The molar amounts of A, B, X, Y, and Z, the reacting fluid temperature, and the exhhange fluid temperature at that moment are then the initial values. The solutions charged to the reactor did not contain X, Y, or Z, so their initial values are zero. The assignment provides two final values, $f_{A,f}$ and $t_f$. I will use $t_f$ to define the stopping criterion.

:::

**Intial Values and Stopping Criterion**

The initial values and stopping criterion needed for solving the design equations are given in @tbl-example_9_6_2_initial_values.

| Variable | Initial Value | Stopping Criterion |
|:------:|:-------:|:-------:|
| $t$ | $0$ | $t_f$ |
| $n_A$ | $n_{A,0}$ | |
| $n_B$ | $n_{B,0}$ | |
| $n_X$ | $0$ | |
| $n_Y$ | $0$ | |
| $n_Z$ | $0$ | |
| $T$ | $T_0$ | |
| $T_{ex}$ | $T_{ex,0}$ | |
  
: Initial values and stopping criterion for solving design equations, (5) through (11). {#tbl-example_9_6_2_initial_values}

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The initial and final values in @tbl-example_9_6_2_initial_values must be calculated before the IVODEs can be solved. The initial molar amounts of A and B can be calculated using their given initial concentrations and the reacting fluid volume. The final value, $t_f$, is a given constant. However, the initial value of the temperature is not known and it can't be calculated directly from the other given constants. Using the terminology of @sec-apndx_solve_ivodes, $T_0$ is a "missing initial value."

The other given final value, $f_{A,f}$, can be used to write an implicit equation for $T_0$ (see @sec-apndx_solve_ivodes). The conversion in a closed system is defined by @eq-conversion_def_closed. Rearranging that equation gives an expression for the final molar amount of A. This is an implicit equation for $T_0$; it will only be true for one value of T$_0$. This implicit equation will be solved numerically using an ATE solver, so it can be re-written in the form of a residual expression.

$$
n_A \big \vert_{t=t_f} = {n_{A,0}} \left(1 - f_{Af} \right)
$$

:::

**Ancillary Equations for Calculating the Initial and Final Values**

The initial molar amounts of A and B in @tbl-example_9_6_2_initial_values can be calculated using equations (17) and (18). The initial value of the temperature can be found by solving the implicit equation (19), where $T_0$ is the unknown. Equation (19) can be solved numerically using an ATE solver (see @sec-apndx_solve_ates).

$$
n_{A,0} = C_{A,0}V \tag{17}
$$

$$
n_{B,0} = C_{B,0}V \tag{18}
$$

$$
0 = n_A \big \vert_{t=t_f} - {n_{A,0}} \left(1 - f_{Af} \right) = \epsilon \tag{19}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

At this point the reactor design equations together with equation (19) can be solved to find $T_0$, and $n_A\left(t\right)$, $n_B\left(t\right)$, $n_X\left(t\right)$, $n_Y\left(t\right)$, $n_Z\left(t\right)$, $T\left(t\right)$, and $T_{ex}\left(t\right)$ in the range from $t=0$ to $t=t_f$. $T_0$ is one of the quantities of interest. The others can be found or calculated using the results from solving the IVODEs and the defining equation for selectivity, @eq-selectivity_def_closed.

:::

**Ancillary Equations for Calculating Other Quantities of Interest**

With the information given above, equations (5) through (11), together with equation (19), can be solved for $T_0$ and $n_A\left(t\right)$, $n_B\left(t\right)$, $n_X\left(t\right)$, $n_Y\left(t\right)$, $n_Z\left(t\right)$, $T\left(t\right)$, and $T_{ex}\left(t\right)$ in the range from $t=0$ to $t=t_f$. The resulting values at $t=t_f$ can be used to calculate the other quantities of interest.

$$
T_f = T\big\vert_{t=t_f} \tag{20}
$$

$$
T_{ex,f} = T_{ex}\big\vert_{t=t_f} \tag{21}
$$

$$
S_{X/Z,f} = \frac{n_X \Big\vert_{t=t_{rxn}}}{n_Z \Big\vert_{t=t_{rxn}}} \tag{22}
$$

**Calculations Summary**

1. Substitute given and known constants into all equations.
2. To calculate $r_1$, $r_2$, and $\dot{Q}$ knowing $t$, $n_A$, $n_B$, $n_X$, $n_Y$, $n_Z$, $T$, and $T_{ex}$,
	a. calculate $\dot{Q}$ using equation (16),
	b. calculate $k_1$, $k_2$, $C_A$, and $C_B$ using equations (12) - (15)
	c. calculate $r_1$ and $r_2$ using equations (3) and (4).
3. To calculate $n_{A,0}$ and $n_{B,0}$, use equations (17) and (18).
4. To calculate $\epsilon$ knowing $n_A\left(t\right)$, $n_B\left(t\right)$, $n_X\left(t\right)$, $n_Y\left(t\right)$, $n_Z\left(t\right)$, $T\left(t\right)$, and $T_{ex}\left(t\right)$ use equation (19).
5. To calculate $T_f$, $T_{ex,f}$, $S_{X/Z,f}$ knowing $n_A\left(t\right)$, $n_B\left(t\right)$, $n_X\left(t\right)$, $n_Y\left(t\right)$, $n_Z\left(t\right)$, $T\left(t\right)$, and $T_{ex}\left(t\right)$ use equations (20), (21), and (22).

#### Numerical Implementation of the Solution

:::{.callout-tip collapse="true"}

## Click Here to See What an Expert Might be Thinking at this Point

The design equations are IVODEs and can be solved as described in [Appendix -@sec-example_J_6_2]. The IVODEs were written in the form of derivative expressions, so no additional equations are needed for writing the derivatives function.

:::

1. Make the given and known constants available for use in all equations.
2. Define a variable representing the current value of $T_0$ and make it available to all functions.
3. Write a derivatives function that 
    a. receives $t$, $n_A$, $n_B$, $n_X$, $n_Y$, $n_Z$, $T$, and $T_{ex}$ as arguments,
    b. calculates $r_1$, $r_2$, and $\dot{Q}$ (step 2 in the calculations summary), and
    d. evaluates and returns the derivatives using equations (5) through (11).
4. Write a reactor model function that
	a. calculates $n_{A,0}$ and $n_{B,0}$ (step 3 in the calculations summary),
	b. calls an IVODE solver using the following arguments
		i. the initial values (including the current value of $T_0$) and the stopping criterion in @tbl-example_9_6_1_initial_values and
		ii. the name of the derivatives function from step 3,
	c. checks that the solver sucessfully solved the IVODEs, and
	d. returns sets of corresponding values of $t$, $n_A$, $n_B$, $n_X$, $n_Y$, $n_Z$, $T$, and $T_{ex}$ that span the range from their initial value to their final value.
5. Write a residuals function that
	a. receives a guess for $T_0$ and sets the current value of $T_0$ equal to that guess,
	b. calls the reactor model function to get $n_A\left(t\right)$, $n_B\left(t\right)$, $n_X\left(t\right)$, $n_Y\left(t\right)$, $n_Z\left(t\right)$, $T\left(t\right)$, and $T_{ex}\left(t\right)$, and
	c. calculates and returns $\epsilon$ (step 4 in the calculations summary).
6. Complete the analysis by
	a. calculating $T_0$ by calling an ATE solver using the following arguments
		i. an initial guess for $T_0$ and
		ii. the name of the residuals function from step 5,
	b. setting the current value of $T_0$ equal to the result from step 6a,
	c. calling the reactor model function from step 4 to get sets of values of $t$, $n_A$, $n_B$, $n_X$, $n_Y$, $n_Z$, $T$, and $T_{ex}$,
	d. calculating $T_f$, $T_{ex,f}$, $S_{X/Z,f}$ (step 5 in the calculations summary).

#### Results and Discussion

```{r}
#| echo: false
#| output: false
df <- read.csv("results/reb_9_6_2_results.csv")
df <- fmt_tibble_col(df, 2, 3, 2, 1)
```

The calculations were performed as described above. The initial temperature must be `r df$value[1]` `r df$units[1]` for the conversion to equal 45% after 30 min of reaction. At that time, the temperature of the reacting fluid will be `r df$value[2]` `r df$units[2]`, the exit temperature of the exchange fluid will be `r df$value[3]` `r df$units[3]`, and the selectivity will equal `r df$value[4]` `r df$units[4]`.

Solving the reactor design equations using an initial temperature of `r df$value[1]` `r df$units[1]` also yields the final molar amount of $n_A$. One way to check the results is to use that value to calculate the conversion and make sure that it is equal to 45%. Indeed, when the design equations were solved using an initial temperature of `r df$value[1]` `r df$units[1]`, the resulting conversion of A was `r df$value[5]` `r df$units[5]`.

:::{.callout-note collapse="false"}
## Note

This example specified two final values: the reaction time and the fractional conversion. In the solution presented above, the reaction time was used as the stopping criterion when solving the IVODEs and the fractional conversion was used in the implicit equation for the $T_0$.

The roles of the reaction time and conversion could have been reversed. The specified conversion could have been used to calculate the corresponding final moles of A, which then could have been used as the stopping criterion. Then the reaction time would have been used in the implicit equation for $T_0$. The results would be the same.

:::


### Maximum Intermediate Yield in Series Reactions {#sec-example_9_6_3}

{{< include problem_statements/reb_9_6_3.qmd >}}

---

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

This assignment describes a single BSTR and no other reactors, heat exchangers, or stream mixing/splitting points. It describes the reactor, its operation, and the reactions taking place, including the rate expressions. It asks me to find a reaction time to maximize yield. From these characteristics, I know that this is an isolated reactor modeling assignment. I know the general approach to completing an isolated reactor modeling assignment that was described in @sec-4_response_opt_design has five basic steps.

1. Summarize the information provided in the assignment.
2. Formulate the solution mathematically.
3. Implement the solution numerically.
4. Execute the solution.
5. Report and comment upon the results.

To summarize the information provided in the assignment I'll read through the problem and extract the following information:

1. Summarize the information provided in the assignment.
	a. Reactor type and operational mode
	b. Constant quantities
	c. Adjusted quantities
	d. Missing reactor input or process parameter and specified reactor response
	e. Quantities of interest

:::

**Information Provided in the Assignment**

**Reactor**: BSTR with heat transfer

**Given Constants**: $P_{A,0}$ = 1 atm, $P_{B,0}$ = 2 atm, $T_0$ = 25 °C, $V$ = 2 L, $A$ = 600 cm^2^, $U$ = 0.6 cal cm^-2^ min^-1^ K^-1^, $T_{ex}$ = 30 °C, $k_{0,1}$ =  3.34 x 10^9^ mol cm^-3^ min^-1^ atm^-2^, $k_{0,2}$ = 4.99 x 10^9^ mol cm^-3^ min^-1^ atm^-2^, $E_1$ = 20.5 kcal mol^-1^, $E_2$ = 21.8 kcal mol^-1^, $\Delta H_1$ = -6,300 cal mol^-1^, $\Delta H_2$ = -6,900 cal mol^-1^, $\hat C_{p,A}$ = 7.4 cal mol^-1^ K^-1^, $\hat C_{p,B}$ = 8.6 cal mol^-1^ K^-1^, $\hat C_{p,D}$ = 10.7 cal mol^-1^ K^-1^, $\hat C_{p,Z}$ = 5.2 cal mol^-1^ K^-1^ and $\hat C_{p,U}$ = 10.3 cal mol^-1^ K^-1^.

**Quantities of Interest**: $t_{rxn,opt} = \underset{t}{\arg\max} \left(Y_{D/A}\right)$, $\underset{t}\max \left(Y_{D/A}\right)$, and $f_A\Big\vert_{t_{rxn,opt}}$.

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The second basic step for completing an isolated BSTR modeling assignment is to formulate the solution mathematically. From my reading of this chapter, I know, generally, how to do this.

2. Formulate the solution mathematically.
	a. Choose, write and simplify the reactor design equations needed to model the reactor.
	b. Identify the independent variable and the dependent variables, and ensure that the number of dependent variables is equal to the number of reactor design equations.
	c. Specify the initial values and the stopping criterion, and write equations for calculating their values.
	d. Write equations to express every quantity appearing in the reactor design equations or in equations that will be substituted into the reactor design equations in terms of known constants, the independent variable, the dependent variables, the missing reactor input or process parameter (if there is one), and the adjusted quantities (if there are any).
	e. Write the equations to calculate every quantity of interest and the response that was specified in the assignment (if there is one) using the results from solving the reactor design equations, the independent variable, the dependent variables, the missing reactor input or process parameter (if there is one), and the adjusted quantities (if there are any).
	f. Briefly explain or outline the sequence of calculations that must be used to calculate and process the quantities of interest (and the response that was specified in the assignment, if there is one).

:::

**Mathematical Formulation of the Solution**

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

Mole balances are always included in the reactor design equations. The general BSTR mole balance is given in @eq-bstr_mole_balance. I will use this equation to write mole balances for every reagent in the system. That is, I'll write the mole balance for $i$ = A, B, D, Z, and U. There are two reactions taking place, so the sum will expand to two terms in each mole balance.

$$
\frac{dn_i}{dt} = V \sum_j \nu_{i,j}r_j = \left( \nu_{i,1}r_1 + \nu_{i,2}r_2 \right)V
$$

This reactor is not isothermal, so I will need to include a BSTR reacting fluid energy balance among the reactor design equations. The BSTR energy balance is given in @eq-bstr_energy_balance. This reactor has rigid walls and no moving boundaries, so it's volume is constant. If the volume is constant, the time-derivative of the volume is equal to zero. Being a gas phase system with a constant volume, the pressure is expected to change because the temperature will change. Therefore I *cannot* set the time-derivative of the pressure equal to zero. With no moving boundaries, the only work is that of the agitator, which is assumed to be negligible.  The summation over $i$ includes every reagent, and as above, the summation over $j$ expands to two terms.

$$
\left(\sum_i n_i \hat C_{p,i} \right) \frac{dT}{dt} - V\frac{dP}{dt}  - P  \cancelto{0}{\frac{dV}{dt}}  = \dot Q - \cancelto{0}{\dot W} - V \cancelto{\left( r_1 \Delta H_1 + r_2 \Delta H_2\right)}{\sum_j \left(r_j \Delta H_j \right)}
$$

$$
\left( n_A \hat C_{p,A} + n_B \hat C_{p,B} + n_D \hat C_{p,D} + n_Z \hat C_{p,Z} + n_U \hat C_{p,U}  \right) \frac{dT}{dt} - V\frac{dP}{dt}  = \dot Q - \left( r_1 \Delta H_1 + r_2 \Delta H_2\right)V
$$

An exchange fluid is present in this reactor, but the assignment states that its temperature is constant at 30 °C. Knowing the exchange fluid temperature, the other reactor design equations can be solved independently of an energy balance on the exchange fluid, so I do not need to include an energy balance on the exchange fluid among the reactor design equations.

:::

**Reactor Design Equations**

Mole balances of each of the reagents are presented in equations (5) through (9), and an energy balance on the reacting fluid is presented in equation (10).

$$
\frac{dn_A}{dt} = -r_1V \tag{5}
$$

$$
\frac{dn_B}{dt} = \left( -r_1 - r_2 \right)V \tag{6}
$$

$$
\frac{dn_D}{dt} = \left( r_1 - r_2 \right)V \tag{7}
$$

$$
\frac{dn_Z}{dt} = \left( r_1 + r_2 \right)V \tag{8}
$$

$$
\frac{dn_U}{dt} = r_2V \tag{9}
$$

$$
\begin{aligned}
- V\frac{dP}{dt} + &\left( n_A \hat C_{p,A} + n_B \hat C_{p,B} + n_D \hat C_{p,D} + n_Z \hat C_{p,Z} + n_U \hat C_{p,U}  \right) \frac{dT}{dt} \\&= \dot Q  - \left( r_1 \Delta H_1 + r_2 \Delta H_2\right)V
\end{aligned} \tag{10}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

At this point I have 6 initial value ordinary differential equations (IVODEs) that contain 7 dependent variables ($n_A$, $n_B$, $n_D$, $n_Z$, $n_U$, $P$, and $T$). I either need to eliminate a dependent variable or add an IVODE before I can solve the reactor design equations.

Noting that V is constant, I'm going to take the time-derivative of the ideal gas law and use it as an additional IVODE.

$$
PV - \left(n_A + n_B + n_D + n_Z + n_U \right)RT =0
$$

$$
\begin{aligned}
V\frac{dP}{dt} &- RT\left(\frac{dn_A}{dt} + \frac{n_B}{dt} + \frac{n_D}{dt} + \frac{n_Z}{dt} + \frac{n_U}{dt} \right) \\&- R\left(n_A + n_B + n_D + n_Z + n_U \right)\frac{dT}{dt} = 0
\end{aligned}
$$

:::

Taking the derivative of the ideal gas law yields equation (11).

$$
\begin{aligned}
- &RT\left(\frac{dn_A}{dt} + \frac{n_B}{dt} + \frac{n_D}{dt} + \frac{n_Z}{dt} + \frac{n_U}{dt} \right) + V\frac{dP}{dt} \\&- R\left(n_A + n_B + n_D + n_Z + n_U \right)\frac{dT}{dt} = 0
\end{aligned}\tag{11}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

I now have 7 IVODEs with 7 dependent variables. Initial values and a stopping criterion are needed in order to solve these equations. I can define $t=0$ to be instant that the A and B are added to the reactor, and let $n_{A,0}$, $n_{B,0}$, $P_0$, and $T_0$ represent the molar amounts of A and B, the pressure, and the temperature at that instant. The initial molar amounts of A and B are not given, but their initial partial pressures are. Consequently, the initial molar amounts of A and B can be calculated using the ideal gas law. Initially the reactor does not contain D, Z, or U, so the initial molar amounts of those reagents are equal to zero. The initial temperature is given and the initial pressure can be calculated using the initial partial pressures of the reagents given in the assignment.

The assignment asks for the reaction time that will maximize the yield, so I need to vary the reaction time over a range of values, as indicated in the information summary. Because the reaction time is the independent variable, I do not need to solve the design equations many times using different values of the reaction time. Instead, I can set the reaction time to a large value and use it as the stopping criterion, $t=t_{rxn}$. Solving the design equations will yield $n_A\left(t\right)$, $n_B\left(t\right)$, $n_D\left(t\right)$, $n_Z\left(t\right)$, $n_U\left(t\right)$, $P\left(t\right)$, and $T\left(t\right)$, from which I can calculate $Y_{D/A}\left(t\right)$ (see below). If the yield does not exhibit a maximum at times between $t=0$ and $t=t_{rxn}$, I'll need to set the reaction time to a larger value and repeat the calculations.

:::

The initial values and stopping criterion for solving equations (5) through (11) are presented in @tbl-example_13_3_initial_values. The initial molar amounts of A and B can be calculated using equations (12) and (13), and the initial total pressure is the sum of the initial partial pressures, equation (14). The reaction time needs to be adjusted to find the time that maximizes the yield. Consequently, a value can be chosen for $t_{rxn}$. Doing so will yield results that span times from zero to the chosen value when the equations are solved numerically.

| Variable | Initial Value | Stopping Criterion |
|:-------|:-------:|:-------:|
| $t$ | $0$ | $t_{rxn}$ |
| $n_A$ | $n_{A,0}$ | |
| $n_B$ | $n_{B,0}$ | |
| $n_D$ | $0$ | |
| $n_Z$ | $0$ | |
| $n_U$ | $0$ | |
| $P$ | $P_0$ | |
| $T$ | $T_0$ | |
  
: Initial values and stopping criterion for solving the design equations, (5) through (11). {#tbl-example_13_3_initial_values}

$$
n_{A,0} = \frac{P_{A,0}V}{RT} \tag{12}
$$

$$
n_{B,0} = \frac{P_{B,0}V}{RT} \tag{13}
$$

$$
P_0 = P_{A,0} + P_{B,0} \tag{14}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The design equations cannot be solved until every quantity appearing in them and every quantity substituted into them is expressed in terms of known constants, the independent variable and the dependent variables. Looking at the quantities in the IVODEs, $V$, $\hat C_{p,A}$, $\hat C_{p,B}$, $\hat C_{p,D}$, $\hat C_{p,Z}$, $\hat C_{p,U}$, $\Delta H_1$, $\Delta H_2$, and the gas constant, $R$, are known constants. That leaves the reaction rates and the rate of heat transfer to be expressed in terms of known constants, the independent variable, $t$, and the dependent variables, $n_A$, $n_B$, $n_D$, $n_Z$, $n_U$, $T$, and $P$.

The reaction rates are given by equations (3) and (4). Substituting the rate expressions into the reactor design equations introduces the known constants, $k_{0,1}$, $k_{0,2}$, $E_1$, and $E_2$, along with the partial pressures of A, B, and D. The partial pressures can be calculated using the ideal gas law.

The rate of heat transfer, $\dot{Q}$, can be expressed in terms of $T$ and the known, constant heat transfer coefficient, $U$, heat transfer area, $A$, and exchange fluid temperature, $T_{ex}$, @eq-bstr_heat_transfer.

:::

**Ancillary Equations for Solving the Reactor Design Equations**

$$
P_A = \frac{n_ART}{V} \tag{15}
$$

$$
P_B = \frac{n_BRT}{V} \tag{16}
$$

$$
P_D = \frac{n_DRT}{V} \tag{17}
$$

$$
\dot Q = UA\left( T_{ex} - T \right) \tag{18}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

With the information provided above, the design equations can be solved for $n_A\left(t\right)$, $n_B\left(t\right)$, $n_D\left(t\right)$, $n_Z\left(t\right)$, $n_U\left(t\right)$, $P\left(t\right)$, and $T\left(t\right)$. The quantities of interest in the assignment are the reaction time that mazimizes the yield of D and the yield of D and the conversion of A at that reaction time. Using the results from solving the design equations, the yield and conversion as functions of time can be calculated using their definitions.

:::

**Ancillary Equations for Calculating the Quantities of Interest**

$$
Y_{D/A} = \frac{n_D}{n_{A,0}} \tag{19}
$$

$$
f_A=\frac{n_{A,0}-n_A}{n_{A,0}} \tag{20}
$$ 

**Sequence of Calculations to Complete the Assignment**

1. Choose a value for $t_{rxn}$.
2. Substitute given and known constants into all equations.
3. Substitute equations (15) and (16) into equation (3).
4. Substitute equations (16) and (17) into equation (4).
5. Substitute equations (3), (4), and (18) into equations (5) through (11).
6. Calculate $n_{A,0}$, $n_{B,0}$, and $P_0$ using equations (12), (13), and (14).
7. Solve equations (5) through (11) using the initial values and stopping criterion in @tbl-example_13_3_initial_values to get $n_A\left(t\right)$, $n_B\left(t\right)$, $n_D\left(t\right)$, $n_Z\left(t\right)$, $n_U\left(t\right)$, $P\left(t\right)$ and $T\left(t\right)$ at reaction times between 0 and $t_{rxn}$.
8. Use the results to calculate $Y_{D/A}\left(t\right)$ and $f_A\left(t\right)$ using equations (19) and (20).
9. Find $\underset{t}\max \left(Y_{D/A}\right)$, $t_{rxn,opt} = \underset{t}{\arg\max} \left(Y_{D/A}\right)$, and $f_A\Big\vert_{t_{rxn,opt}}$.
	a. If $Y_{D/A}\left(t\right)$ does not pass through a maximum between $t=0$ and $t=t_{rxn}$, repeat from step 1 using a larger value of $t_{rxn}$.
	b. If there is a maximum between $t=0$ and $t=t_{rxn}$, $\underset{t}\max \left(Y_{D/A}\right)$, $t_{rxn,opt} = \underset{t}{\arg\max} \left(Y_{D/A}\right)$, and $f_A\Big\vert_{t_{rxn,opt}}$ are the quantities of interest.

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

Having formulated the solution mathematically, the third basic step for completing an isolated reactor modeling assignment is to implement the solution numerically. I know that this will entail creating two computer functions.

3. Implement the solution numerically.
	a. Create a response function.
		i. Pass the missing value (if there is one) and the adjusted values (if there are any) to it as arguments.
		ii. Solve the reactor design equations for each set of adjusted values.
		iii. Calculate and return the quantities of interest (and the specified response if there is one) corresponding to each set of adjusted values.
	b. Create a calculations function.
		i. Perform the sequence of calculations that is needed to calculate the quantities of interest, calling or using the response function as needed.
		ii. Process the quantities of interest as necessary to complete the assignment.

:::

**Numerical Implementation of the Solution**

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

I know that the purpose of the response function is to calculate the quantities of interest. In this assignment there isn't a missing reactor input or process parameter. That means that the response function will not have a missing value argument.

There is an adjusted value, namely $t$. However, in this assignment I do not need to pass a range of values of $t$ to the response function. I can simply pass a value for $t_{rxn}$ because the IVODE solver will generate a range of values between $t = 0$ and $t=t_{rxn}$ as it solves the IVODEs.

The response function must complete steps 2 through 8 in the sequence given above and then return a vector containing the range of values of $t$ and vectors containing the corresponding values of $Y_{D/A}$ and $f_A$.

:::

**Response Function**

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

I know that in order to solve the design equations numerically I will need to calculate the values of the derivatives, $\frac{dn_A}{dt}$, $\frac{dn_B}{dt}$, $\frac{dn_D}{dt}$, $\frac{dn_Z}{dt}$, $\frac{dn_U}{dt}$, $\frac{dP}{dt}$, and $\frac{dT}{dt}$, given values of the independent variable and the dependent variables. I can do that either of two ways as described in @sec-apndx_solve_ivodes. One way is to algebraically manipulate equations (5) through (11) to put them in the form of a vector equation, Equations [-@eq-example-vector-ode-1] through [-@eq-example-vector-ode-4]. The other way is to write them in the form of a matrix equation, @eq-matrix-form-ivode. Here I will write the IVODEs as a matrix equation.

:::

The design equations can be written as the matrix equation, (21), where the mass matrix, $\boldsymbol{M}$, is defined as shown in equation (22). The values of the derivatives, $\frac{dn_A}{dt}$, $\frac{dn_B}{dt}$, $\frac{dn_D}{dt}$, $\frac{dn_Z}{dt}$, $\frac{dn_U}{dt}$, $\frac{dP}{dt}$, and $\frac{dT}{dt}$, then can be calculated using equation (23).

$$
\boldsymbol{M} \frac{d}{dt}\begin{bmatrix} \frac{dn_A}{dt} \\ \frac{dn_B}{dt} \\  \frac{dn_D}{dt} \\
\frac{dn_Z}{dt} \\ \frac{dn_U}{dt} \\ \frac{dP}{dt} \\ \frac{dT}{dt} \end{bmatrix} =  \begin{bmatrix} -r_1V \\ \left(-r_1 -r_2\right)V \\ \left(r_1 -r_2\right)V \\ \left(r_1 +r_2\right)V \\ r_2V \\ \dot Q  - \left( r_1 \Delta H_1 + r_2 \Delta H_2\right)V \\ 0 \end{bmatrix} \tag{21}
$$

$$
\boldsymbol{M} = \begin{bmatrix} 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & -V & \sum_i n_i \hat C_{p,i} \\
-RT & -RT & -RT & -RT & -RT & V & -R \sum_i n_i   \end{bmatrix} \tag{22}
$$

$$
\frac{d}{dt}\begin{bmatrix} \frac{dn_A}{dt} \\ \frac{dn_B}{dt} \\  \frac{dn_D}{dt} \\
\frac{dn_Z}{dt} \\ \frac{dn_U}{dt} \\ \frac{dP}{dt} \\ \frac{dT}{dt} \end{bmatrix} = \boldsymbol{M}^{-1} \begin{bmatrix} -r_1V \\ \left(-r_1 -r_2\right)V \\ \left(r_1 -r_2\right)V \\ \left(r_1 +r_2\right)V \\ r_2V \\ \dot Q  - \left( r_1 \Delta H_1 + r_2 \Delta H_2\right)V \\ 0 \end{bmatrix} \tag{23}
$$

**Response Function**

The response function is created with the following structure:

* It is passed a value of $t_{rxn}$ as an argument.
* It defines variables and assigns values to them for all known and given quantities.
* It sets the initial values and stopping criterion according to @tbl-example_13_3_initial_values and equations (12), (13), and (14).
* In preparation for solving the IVODEs, it defines a function to evaluate $\frac{dn_A}{dt}$, $\frac{dn_B}{dt}$, $\frac{dn_D}{dt}$, $\frac{dn_Z}{dt}$, $\frac{dn_U}{dt}$, $\frac{dP}{dt}$, and $\frac{dT}{dt}$ using equations (22) and (23). That function
  * receives values for $t$, $n_A$, $n_B$, $n_D$, $n_Z$, $n_U$, $P$, and $T$,
  * calculates $P_A$, $P_B$, $P_D$, and $\dot{Q}$ using equations (15) through (18),
  * calculates $r_1$ and $r_2$ using equations (3) and (4),
  * calculates $\boldsymbol{M}$ using equation (22), and
  * calculates and returns $\frac{dn_A}{dt}$, $\frac{dn_B}{dt}$, $\frac{dn_D}{dt}$, $\frac{dn_Z}{dt}$, $\frac{dP}{dt}$, and $\frac{dT}{dt}$ using equation (23).
* The response function next calls an IVODE solver to solve equations (5) through (11) and get vectors containing values for $t$, $n_A$, $n_B$, $n_D$, $n_Z$, $n_U$, $P$, and $T$, passing the function above and the initial values and stopping criterion in @tbl-example_9_6_2_initial_values as arguments.
* It calculates vectors containing $Y_{D/A}$ and $f_A$ using the results from the IVODE solver and equations (19) and (20).
* Finally, it returns the vectors containing $t$, $Y_{D/A}$, and $f_A$.

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The calculations function is responsible for performing the entire sequence of calculations listed at the end of the mathematical formulation. After setting a value for the reaction time, it can perform steps 2 through 8 by simply calling the response function.

:::

**Calculations Function**

The calculations function is created with the following structure:

* It does not accept any arguments.
* It defines a variable and sets a value for $t_{rxn}$.
* It calls the response function, passing that variable as an argument.
    * The response function returns vectors containing $t$, $Y_{D/A}$, and $f_A$ that span the range from $t=0$ to $t=t_{rxn}$.
* It finds the maximum value of $Y_{D/A}$ and the corresponding values of $t$ and $f_A$.
* It checks that the maximum occurs at a time between $t=0$ to $t=t_{rxn}$.
	* If it does, it reports the maximum value of $Y_{D/A}$ and the corresponding values of $t$ and $f_A$, and saves the results to a file.
	* If it does not, it reports that there wasn't a maximum value between $t=0$ to $t=t_{rxn}$ and suggests using a larger value for $t_{rxn}$.

**Performing the Calculations**

After creating the response function and calculations function as described, all of the calculations needed to complete the assignment can be performed by executing the calculations function.

**Results**

```{r}
#| echo: false
#| output: false
df <- read.csv("results/reb_9_6_3_results.csv")
```

@fig-example_13_3_yield_plot shows the yield *vs*. reaction time. The maximum yield, `r df$value[2]``r df$units[2]`, occurs at a reaction time of `r df$value[1]` `r df$units[1]`. The conversion of A at that reaction time is `r df$value[3]``r df$units[3]`.

![Yield of D as the reaction time varies.](results/reb_9_6_3_yield_vs_t.png){#fig-example_13_3_yield_plot width="80%"}

**Summary**

Reactions (1) and (2) constitute a series-parallel reaction network. The desired product, D, is an intermediate product. It is produced in reaction (1) and consumed in reaction (2). Assuming that the temperature affects the two reactions equally, the yield of an intermediate product is expected to pass through a maximum as the reaction time increases as seen in @fig-example_13_3_yield_plot. This can be predicted using a quantitative analysis

**Qualitative Analysis**

The reason for the maximum is qualitatively easy to understand as long as the effect of temperature is comparable for the two reactions. At the start of the reaction, the concentrations a A and B will be large and those of D, U, and Z will be small. The rate of reaction (1) will be positive while that for reaction (2) will be zero. Consequently, during a very brief interval at the start of the reaction, the concentrations of A and B will decrease and the concentrations of D and Z will increase.

During the next brief interval in time, the rate of reaction (1) will be smaller because the concentrations of A and B will be smaller, and the rate of reaction (2) no longer will equal zero because a small amount D will be present leading to a positive rate. The concentrations of A and B will again decrease and the concentration of Z will again increase. During this second brief interval it can be expected that the rate of reaction (1) will be greater than the rate of reaction (2) because only a small concentration of D will be present. Hence during the second small interval of time, the concentration of D will again increase, as can be seen in @fig-example_13_3_yield_plot. 

For as long as the rate of reaction (2) remains smaller than the rate of reaction (1), the amount of D will be increasing, but its rate of increase will get smaller and smaller. The reason for this is that the concentrations of A and B will be decreasing, and hence the rate of reaction (1) will be decreasing. At the same time, the rate of reaction (2) will be increasing as the concentration of D builds. This can be seen in @fig-example_13_3_yield_plot where the curvature of the yield plot is initially concave downward,

Eventually, the rate of reaction (2) will become equal to the rate of reaction (1). For that instant in time, the yield of D will not be changing. This corresponds to the maximum in @fig-example_13_3_yield_plot. At times beyond the maximum the rate of reaction (1) is less than the rate of reaction (2), so the concentration of D decreases. As the concentrations of both reactants, A and D, continue to decrease, both reactions (1) and (2) become slower and slower. This can be seen at larger reaction times in @fig-example_13_3_yield_plot where the curve is concave upward. Eventually, at very large reaction time, the rates will equal zero and all of the D will have been consumed.

:::{.callout-note collapse="false"}
## Note

When the reactor design equations are solved numerically, a function that calculates the derivatives given values of the independent and dependent variables must be provided. In the solution above, the IVODEs were re-written as a matrix equation and equation (23) was used to calculate the derivatives. There is an alternative approach wherein the IVODEs do not need to be written as a matrix equation.

If equations (5) through (9) are substituted into equation (11), equation (24) results.

$$
\begin{aligned}
- &RT\left(\frac{dn_A}{dt} + \frac{n_B}{dt} + \frac{n_D}{dt} + \frac{n_Z}{dt} + \frac{n_U}{dt} \right) \\&+ V\frac{dP}{dt} - R\left(n_A + n_B + n_D + n_Z + n_U \right)\frac{dT}{dt} = 0
\end{aligned}
$$

&nbsp;

$$
\begin{aligned}
- &RT\cancelto{0}{\left(-r_1V + \left( -r_1 - r_2 \right)V + \left( r_1 - r_2 \right)V + \left( r_1 + r_2 \right)V + r_2V \right)} \\&+ V\frac{dP}{dt} - R\left(n_A + n_B + n_D + n_Z + n_U \right)\frac{dT}{dt} = 0
\end{aligned}
$$

&nbsp;

$$
V\frac{dP}{dt} = R\left(n_A + n_B + n_D + n_Z + n_U \right)\frac{dT}{dt} \tag{24}
$$

Substitution of equation (24) into equation (10) then leads to equation (25).

$$
\begin{aligned}
- &V\frac{dP}{dt} + \\&\left( n_A \hat C_{p,A} + n_B \hat C_{p,B} + n_D \hat C_{p,D} + n_Z \hat C_{p,Z} + n_U \hat C_{p,U}  \right) \frac{dT}{dt} \\&= \dot Q  - \left( r_1 \Delta H_1 + r_2 \Delta H_2\right)V
\end{aligned}
$$

&nbsp;

$$
\begin{aligned}
- &R\left(n_A + n_B + n_D + n_Z + n_U \right)\frac{dT}{dt} + \\&\left( n_A \hat C_{p,A} + n_B \hat C_{p,B} + n_D \hat C_{p,D} + n_Z \hat C_{p,Z} + n_U \hat C_{p,U}  \right) \frac{dT}{dt} \\&= \dot Q  - \left( r_1 \Delta H_1 + r_2 \Delta H_2\right)V
\end{aligned}
$$

&nbsp;

$$
\begin{aligned}
&\begin{pmatrix} n_A \left(\hat C_{p,A} - R\right) + n_B \left(\hat C_{p,B} - R\right) + n_D \left(\hat C_{p,D} - R\right) \\+ n_Z \left(\hat C_{p,Z} - R\right) + n_U \left(\hat C_{p,U} - R\right) \end{pmatrix} \frac{dT}{dt} \\&= \dot Q  - \left( r_1 \Delta H_1 + r_2 \Delta H_2\right)V
\end{aligned}
$$

&nbsp;

$$
\frac{dT}{dt} = \frac{\dot Q  - \left( r_1 \Delta H_1 + r_2 \Delta H_2\right)V}{\begin{pmatrix} n_A \left(\hat C_{p,A} - R\right) + n_B \left(\hat C_{p,B} - R\right) + n_D \left(\hat C_{p,D} - R\right) \\+ n_Z \left(\hat C_{p,Z} - R\right) + n_U \left(\hat C_{p,U} - R\right) \end{pmatrix}} \tag{25}
$$

Here, instead of solving the seven IVODEs, (5) through (11), the six IVODEs, (5), (6), (7), (8), (9), and (25) can be solved to find $n_A\left(t\right)$, $n_B\left(t\right)$, $n_D\left(t\right)$, $n_Z\left(t\right)$, $n_U\left(t\right)$, and $T\left(t\right)$. The pressure, $P\left(t\right)$ can then be calculated using the ideal gas law. 

Notice, in particular, that when solving the latter set of IVODEs numerically, the derivatives, $\frac{dn_A}{dt}$, $\frac{dn_B}{dt}$, $\frac{dn_D}{dt}$, $\frac{dn_Z}{dt}$, $\frac{dn_U}{dt}$, and $\frac{dT}{dt}$, now can be calculated from equations (5), (6), (7), (8), (9), and (25) and there is no need to write the IVODEs as a matrix equation.

:::

:::{.callout-note collapse="false"}
## Note

In this example series-parallel reactions are occurring where the desired product is produced in one reaction and consumed by another. In this situation it is often found that the reaction time has the greatest effect upon the amount of the desired product, as was the case here. Other process parameters such as the temperature will also affect the results, but often their effect on the amount of desired product is weaker. Temperature can be an effective parameter for adjusting the selectivity of multiple reactions if the activation energies of the reactions differ significantly.

:::

### Optimization of Net Production Rate {#sec-example_9_6_4}

{< include ../RE_Basics_Examples/reb_13_4/problem_statement.qmd >}}

```{r}
#| echo: false
#| output: false
path_to_results <- '../RE_Basics_Examples/reb_13_4/Results/'
path_to_figures <- './Graphics/'
```

---

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

Using the criteria presented in @sec-4_response_opt_design, this is an isolated reactor modeling assignment. The system consists of a BSTR and no other equipment. The reactor and its operation are described. The reaction taking place is identified and its rate expression is provided, and it asks for a reactor input, namely the coolant flow rate. This is an optimization assignment because the coolant flow rate of interest is the one that maximizes the net rate of production of Z.

Having identified this as an isolated reactor optimization assignment, I know from @sec-4_response_opt_design that completing the assignment entails five basic steps.

1. Summarize the information provided in the assignment.
2. Formulate the solution mathematically.
3. Implement the solution numerically.
4. Execute the solution.
5. Report and comment upon the results.

To complete the first step, I'll read through the assignment and list the following things. Since this reactor has both a jacket and a coil, I'll use a subscripted "ex" to denote quantities related to the jacket and "coil" to denote quantities related to the coil. The operating protocol for this reactor has two stages, a heating stage and a cooling stage. I'll use a subscripted "0" to denote values of quantities at the start of the heating stage, a subscripted "1" to denote quantities at end of the heating stage (which is also the start of the cooling stage), and a subscripted "f" to denote quantities at the end of the cooling stage (which is also the end of the process).

1. Summarize the information provided in the assignment.
	a. Reactor type and operational mode
	b. Constant quantities
	c. Adjusted quantities
	d. Missing reactor input or process parameter and specified reactor response
	e. Quantities of interest

:::

**Information Provided in the Assignment**

**Reactor**:  BSTR with a 2 step operating protocol

**Given Constants**: $k_{0,1}$ = 2.59 x 10^9^ min^-1^, $E_1$ = 16.5 kcal mol^-1^, $\Delta H_1$ = -22,200 cal mol^-1^, $C_{A,0}$ = 2 M, $T_0$ = 23 °C, $\breve{C}_p$ = 440 cal L^-1^ K^-1^, $V$ = 4.0 L, $V_{ex}$ = 0.5 L, $A_{ex}$ = 0.6 ft^2^, $U_{ex}$ = 1.13 x 10^4^ cal ft^-2^ h^-1^ K^-1^, $T_{ex,in}$ = 20 °C, $\rho_{ex}$ = 1 g cm^-3^, $\tilde{C}_{p,ex}$ = 1 cal g^-1^ K^-1^, $U_{coil}$ = 3.8 x 10^4^ cal ft^-2^ h^-1^ K^-1^, $A_{coil}$ =  0.23 ft^2^, $T_{coil}$ = 120 °C, $T_{ex,0}$ = 23 °C, $T_1$ = 50 °C, $T_f$ = 25 °C, $t_{turn}$ = 25 min.

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

Upon reading the assignment narrative, I see that one of the quantities of interest is the coolant flow rate during the second stage that maximizes the net rate of reaction. To find the optimum coolant flow rate, $\dot{m}_{ex,opt}$, the net rate will be calculated using a range of coolant flow rates, and the one that maximizes the net rate will be identified. For this reason, I'll list the coolant flow rate as an adjusted quantity.

:::

**Adjusted Quantity**: $\dot{m}_{ex}$

**Quantities of Interest**: $\dot{m}_{ex,opt}$, $r_{Z,net,max}$, $f_A\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$, $T\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The second basic step for completing an isolated BSTR modeling assignment is to formulate the solution mathematically. From my reading of this chapter, I know, generally, how to do this.

2. Formulate the solution mathematically.
	a. Choose, write and simplify the reactor design equations needed to model the reactor.
	b. Identify the independent variable and the dependent variables, and ensure that the number of dependent variables is equal to the number of reactor design equations.
	c. Specify the initial values and the stopping criterion, and write equations for calculating their values.
	d. Write equations to express every quantity appearing in the reactor design equations or in equations that will be substituted into the reactor design equations in terms of known constants, the independent variable, the dependent variables, the missing reactor input or process parameter (if there is one), and the adjusted quantities (if there are any).
	e. Write the equations to calculate every quantity of interest and the response that was specified in the assignment (if there is one) using the results from solving the reactor design equations, the independent variable, the dependent variables, the missing reactor input or process parameter (if there is one), and the adjusted quantities (if there are any).
	f. Briefly explain or outline the sequence of calculations that must be used to calculate and process the quantities of interest (and the response that was specified in the assignment, if there is one).

:::

**Mathematical Formulation of the Solution**

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The operational protocol for this reactor has two stages. I need to write and simplify the reactor design equations needed to model each stage of the operation of this system. The reactor is the same in the heating and cooling stages, so the same reactor design equation apply to both stages, but some of the terms in the equations change between the first and second stage of operation.

The reactor design equations always include at least one mole balance. The general BSTR mole balance is given in @eq-bstr_mole_balance.  I'll write a mole balance for both of the reagents in this system, noting that the sum reduces to a single term since only one reaction is taking place.

$$
\frac{dn_i}{dt} = V \cancelto{\nu_{i,1}r_1}{\sum_j \nu_{i,j}r_j}
$$

The BSTR is not isothermal, so I must include an energy balance on the reacting fluid among the design equations. The general BSTR mole balance is given in @eq-bstr_energy_balance. Assuming the liquid to be incompressible and the reactor walls to be rigid, both the pressure and volume will be constant, so their time-derivatives will equal zero. The work associated with mixing the reactor can also be assumed to be negligible. There is only one reaction occurring, so the final sum will reduce to a single term. In addition, the assignment provides the volumetric heat capacity of the entire solution, so the sensible heat term can be written in terms of that heat capacity, @eq-bstr_equivalent_sens_heat_terms. During the first stage of the operating protocol, heat is exchanged with both the cooling water and the steam, so the rate of heat exchange must be split into two terms. During the second stage the coil is not present.

$$
\cancelto{V \breve{C}_p}{\left(\sum_i n_i \hat C_{p,i} \right)} \frac{dT}{dt} - V\cancelto{0}{\frac{dP}{dt}}  - P  \cancelto{0}{\frac{dV}{dt}}  = \cancelto{\dot{Q}_{ex} + \dot{Q}_{coil}}{\dot Q} - \cancelto{0}{\dot W} - V \cancelto{r_1 \Delta H_1}{\sum_j \left(r_j \Delta H_j \right)}
$$

$$
V \breve{C}_p \frac{dT}{dt} = \dot{Q}_{ex} + \dot{Q}_{coil} - V r_1 \Delta H_1
$$

There are two heat exchange fluids in this system. The water in the jacket exchanges sensible heat so the energy balance on it is given by @eq-exchange_energy_bal_sensible. During the first stage of the operating protocol, the coolant is not flowing, so $\dot{m}_{ex} = 0$. Noting that the heat capacity is constant, the integral is easily evaluated.

$$
\rho_{ex} V_{ex} \tilde C_{p,ex}\frac{dT_{ex}}{dt} = -\dot{Q}_{ex} - \dot m_{ex} \int_{T_{ex,in}}^{T_{ex}} \tilde C_{p,ex}dT
$$

The steam in the coil exchanges latent heat, so its temperature is known and constant. As a consequence, the mole balances, energy balance on the reacting fluid and energy balance on the cooling water can be solved independently of the energy balance on the steam. The problem does not ask any questions about the steam flow rate or how much of it condenses, so an energy balance on the steam is not needed.

Momentum balances are not used for stirred tank reactors, so the full set of reactor design equations consists of mole balances on A and Z, an energy balance on the reacting fluid and an energy balance on the cooling water.

:::

**Reactor Design Equations**

Mole balances on A and Z, equations (3) and (4) are the same in heating stage of the protocol and in the cooling stage. An energy balance on the reacting fluid and an energy balance on the coolant in the shell during the heating stage are shown in equations (5) and (6). During the cooling stage of the operating protocol, an energy balance on the reacting fluid and an energy balance on the coolant take the forms shown in equations (7) and (8).

$$
\frac{dn_A}{dt} = -Vr_1 \tag{3}
$$

$$
\frac{dn_Z}{dt} = Vr_1 \tag{4}
$$

$$
\frac{dT}{dt} = \frac{\dot{Q}_{ex} + \dot{Q}_{coil}  - Vr_1 \Delta H_1}{V \breve C_p} \tag{5}
$$

$$
\frac{dT_{ex}}{dt} = -\left(\frac{\dot{Q}_{ex}}{\rho_{ex} V_{ex} \tilde C_{p,ex}}\right) \tag{6}
$$

$$
\frac{dT}{dt} = \frac{\dot{Q}_{ex}  - Vr_1 \Delta H_1}{V \breve C_p} \tag{7}
$$

$$
\frac{dT_{ex}}{dt} = -\left(\frac{\dot{Q}_{ex} + \dot m_{ex} \tilde{C}_{p,ex} \left(T_{ex} - T_{ex,in}\right)}{\rho_{ex} V_{ex} \tilde C_{p,ex}}\right) \tag{8}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

In both stages of operation, the four reactor design equations are IVODEs, and they contain four dependent variables ($n_A$, $n_B$, $T$, and $T_{ex}$), so no additional IVODEs are needed. Initial values and a stopping criterion are needed to solve the design equations.

The instant the solution is added to the reactor can be defined as $t=0$. This marks the start of the heating phase. The molar amounts of A, $n_{A,0}$, and Z, 0.0 (only A is present initially), the reacting fluid temperature, $T_0$, and the cooling water temperature, $T_{ex,0}$, at that time are then the initial values for the analysis of the heating phase. It ends when the reacting fluid reaches $T_1 = 50 °C$.  The initial molar amount of A is not given, but it can be calculated from the initial concentration.

The cooling phase begins the instant the heating phase ends, so the initial values for the cooling phase are the final values from the heating phase. The cooling phase ends when the reacting fluid cools down to $T_f = 25 °C$, so that is the stopping criterion for the cooling phase.

:::

The initial values and stopping criterion for solving the reactor design equations for the heating phase are presented in @tbl-example_13_4_heating_initial_values. The initial molar amount of A can be calculated using equation (9). If $t_1$, $n_{A,1}$, $n_{Z,1}$, and $T_{ex,1}$ represent the values of $t$, $n_A$, $n_Z$, and $T_{ex}$ at the end of the heating phase, those values are also the initial values for the cooling phase, which ends when $T = T_f$. Thus, the initial values and stopping criterion for the cooling phase are given in @tbl-example_13_4_cooling_initial_values

| Variable | Initial Value | Stopping Criterion |
|:-------|:-------:|:-------:|
| $t$ | $0$ | |
| $n_A$ | $n_{A,0}$ | |
| $n_Z$ | 0 | |
| $T$ | $T_0$ | $T_1$ |
| $T_{ex}$ | $T_{ex,0}$ | |
  
: Initial values and stopping criterion for solving the design equations for the heating stage of the operating protocol, equations (3) through (6). {#tbl-example_13_4_heating_initial_values}

$$
n_{A,0} = C_{A,0}V \tag{9}
$$


| Variable | Initial Value | Stopping Criterion |
|:-------|:-------:|:-------:|
| $t$ | $t_1$ | |
| $n_A$ | $n_{A,1}$ | |
| $n_Z$ | $n_{Z,1}$ | |
| $T$ | $T_1$ | $T_f$ |
| $T_{ex}$ | $T_{ex,1}$ | |
  
: Initial values and stopping criterion for solving the design equations for the cooling stage of the operating protocol, equations (3), (4), (7) and (8).. {#tbl-example_13_4_cooling_initial_values}

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The design equations cannot be solved until every quantity appearing in them and every quantity substituted into them is expressed in terms of known constants, the independent variable, $t$, and the dependent variables, $n_A$, $n_Z$, $T$, and $T_{ex}$. As noted earlier, the design equations will be solved using a range of values of $\dot{m}_{ex}$, so $\dot{m}_{ex}$ will be a known constant when the reactor design equations are solved.

Looking at the reactor design equations, I see that $V$, $\breve{C}_p$, $\Delta H_1$, $\rho_{ex}$, $\tilde{C}_{p,ex}$, $\dot{m}_{ex}$, and $T_ex,in$ are known constants. The remaining quantities in the reactor design equations, $r_1$, $\dot{Q}=_{ex}$, and $\dot{Q}_{coil}$ must be expressed in terms of known constants, the independent variable, and the dependent variables.

The reaction rate, $r_1$, is given by equation (2); it introduces $k_1$ and $C_A$ when it is substituted into the design equations. The rate coefficient can be expressed in terms of known constants ($k_{0,1}$, $E_1$, and the gas constant, $R$) using the Arrhenius expression, @eq-arrhenius. The concentration of A can be expressed in terms of the molar amount of A and the volume using the definition of concentration.

The rate of heat exchange between the water in the jacket and the reacting fluid can be expressed in terms of the known constants, $A_{ex}$ and $U_{ex}$, and the jacket and reacting fluid temperatures. Similarly, the rate of heat exchange between the steam in the coil and the reacting fluid can be expressed in terms of the known constants, $U_{coil}$, $A_{coil}$, and $T_{coil}$ = 120 °C, and the reacting fluid temperature.

:::

**Ancillary Equations for Solving the Reactor Design Equations**

The rate is given by equation (2), where the rate coefficient is found using equation (8) and the concentration of A is found using equation (9).

$$
k_1 = k_{0,1}\exp{\left( \frac{-E_1}{RT} \right)} \tag{10}
$$

$$
C_A = \frac{n_A}{V} \tag{11}
$$

The rate of heat exchange with the steam in the coil is given by equation (10), and the rate of heat exchange between the water in the jacket and the reacting fluid is given by equation (11).

$$
\dot{Q}_{coil} = U_{coil} A_{coil} \left(T_{coil} - T\right) \tag{12}
$$

$$
\dot{Q}_{ex} = U_{ex} A_{ex} \left(T_{ex} - T\right) \tag{13}
$$

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

At this point, the design equations can be solved to find $n_A\left(t\right)$, $n_Z\left(t\right)$, $T\left(t\right)$, and $T_{ex}\left(t\right)$ at times between $t=0$ and the time, $t_f$ (the time when the reactor has cooled to 25 °C). The net rate of production of Z can then be calculated using , and the conversion as a function of processing time can be calculated using its definition, @eq-conversion_def_closed. If the calculations are repeated using a range of values of $\dot{m}_{ex}$ that is sufficiently wide that $r_{Z,net}$ passes through a maximum, the maximum net rate and the optimum coolant flow rate can be identified.

:::

**Ancillary Equations for Calculating the Quantities of Interest**

$$
r_{Z,net} = \frac{n_Z\big\vert_{t_f}}{t_f + t_{turn}} \tag{14}
$$

$$
f_A\left(t\right) = \frac{n_{A,0} - n_A\left(t\right)}{n_{A,0}} \tag{15}
$$

$$
\dot{m}_{ex,opt} = \underset{\dot{m}_{ex}}{\arg\max}\left( r_{Z,net} \right) \tag{16}
$$

$$
r_{Z,net,max} = \underset{\dot{m}_{ex}}{\max}\left( r_{Z,net} \right) \tag{17}
$$

**Sequence of Calculations to Complete the Assignment**

1. Choose a value for $\dot{m}_{ex}$.
2. Substitute given and known constants into all equations.
3. Substitute equations (10) and (11) into equation (2).
4. Substitute equations (2), (12) and (13) into equations (3) through (8).
5. Calculate $n_{A,0}$ using equation (9).
6. Solve equations (3) through (6) using the initial values and stopping criterion in @tbl-example_13_4_heating_initial_values to get $n_A\left(t\right)$, $n_Z\left(t\right)$, $T\left(t\right)$ and $T_{ex}\left(t\right)$ during the heating stage.
7. Solve equations (3), (4), (7), and (8) using the initial values and stopping criterion in @tbl-example_13_4_cooling_initial_values to get $n_A\left(t\right)$, $n_Z\left(t\right)$, $T\left(t\right)$ and $T_{ex}\left(t\right)$ during the cooling stage.
8. Calculate $r_{Z,net}$ using equation (15).
9. Repeat steps 1 through 8 many times using a range of values of $\dot{m}_{ex}$ that is broad enough for $r_{Z,net}$ to pass through a maximum.
10. Identify the optimum coolant flow rate and the maximum net rate using equations (16) and (17).
11. Repeat steps 1 through 7 using the optimum coolant flow rate in step 1.
12. Use the results from step 7 to calculate the conversion as a function of time at the optimum coolant flow rate, equation (15).
13. Plot $f_A\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$ *vs*. $t$ and $T\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$ *vs*. $t$.

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

Having formulated the solution mathematically, the third basic step for completing an isolated reactor modeling assignment is to implement the solution numerically. I know that this will entail creating two computer functions.

3. Implement the solution numerically.
	a. Create a response function.
		i. Pass the missing value (if there is one) and the adjusted values (if there are any) to it as arguments.
		ii. Solve the reactor design equations for each set of adjusted values.
		iii. Calculate and return the quantities of interest (and the specified response if there is one) corresponding to each set of adjusted values.
	b. Create a calculations function.
		i. Perform the sequence of calculations that is needed to calculate the quantities of interest, calling or using the response function as needed.
		ii. Process the quantities of interest as necessary to complete the assignment.

:::

**Numerical Implementation of the Solution**

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

I know that the purpose of the response function is to calculate the quantities of interest. In this assignment there isn't a missing reactor input or process parameter. That means that the response function will not have a missing value argument.

There is an adjusted value, namely $\dot{m}_{ex}$, so the response function will be passed a vector containing a range of values of $\dot{m}_{ex}. The response function must loop through those values. For each one it needs to complete steps 2 through 12 in the sequence given above. It should then return the quantities of interest: $\dot{m}_{ex,opt}$, $r_{Z,net,max}$, $f_A\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$, $T\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$.

:::

**Response Function**

The response function is created with the following structure:

* It is passed vector containing a range of coolant flow rates, $\dot{m}_{ex}$, as an argument.
* It defines variables and assigns values to them for all known and given constants.
* It loops over the values of the coolant flow rate. For each coolant flow rate
	* It sets the initial values and stopping criterion according to @tbl-example_13_4_heating_initial_values and equation (9).
	* In preparation for solving equations (3) through (6), it defines a function to evaluate $\frac{dn_A}{dt}$, $\frac{dn_Z}{dt}$, $\frac{dT}{dt}$, and $\frac{dT_{ex}}{dt}$ using equations (3) through (6). That function
		* receives values for $t$, $n_A$, $n_Z$, $T$, and $T_{ex}$,
		* calculates $k$ and $C_A$ using equations (10) and (11),
		* calculates $r_1$, $\dot{Q}_{coil}$, and $\dot{Q}_{ex}$ using equations (4), (12), and (13).
		* calculates and returns $\frac{dn_Z}{dt}$, $\frac{dT}{dt}$, and $\frac{dT_{ex}}{dt}$ using equations (3) through (6).
	* The response function next calls an IVODE solver to solve equations (3) through (6) and get vectors containing values for $t$, $n_A$, $n_Z$, $T$, and $T_{ex}$ during the heating stage, passing the function above and the initial values and stopping criterion in @tbl-example_13_4_heating_initial_values as arguments.
	* In preparation for solving equations (3), (4), (7), and (8), it defines a function to evaluate $\frac{dn_A}{dt}$, $\frac{dn_Z}{dt}$, $\frac{dT}{dt}$, and $\frac{dT_{ex}}{dt}$ using those equations. That function
		* receives values for $t$, $n_A$, $n_Z$, $T$, and $T_{ex}$,
		* calculates $k$ and $C_A$ using equations (10) and (11),
		* calculates $r_1$, $\dot{Q}_{coil}$, and $\dot{Q}_{ex}$ using equations (4), (12), and (13).
		* calculates and returns $\frac{dn_Z}{dt}$, $\frac{dT}{dt}$, and $\frac{dT_{ex}}{dt}$ using equations (3), (4), (7), and (8).
	* The response function next calls an IVODE solver to solve equations (3), (4), (7), and (8) and get vectors containing values for $t$, $n_A$, $n_Z$, $T$, and $T_{ex}$ during the cooling stage, passing the function above and the initial values and stopping criterion in @tbl-example_13_4_cooling_initial_values as arguments. 
	* It calculates and saves $r_{Z,net}$ using equation (14).
* After looping through all of the coolant flow rates, it identifies the maximum net rate and the corresponding optimum coolant flow rate, equations (16) and (17).
* It solves the IVODEs as above using the optimum coolant flow rate.
* It combines the results for the heating stage and the cooling stage.
* It calculate $f_A\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$.
* It returns the quantities of interest: $\dot{m}_{ex,opt}$, $r_{Z,net,max}$, $f_A\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$, $T\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$.

:::{.callout-tip collapse="true"}
## Click Here to See What an Expert Might be Thinking at this Point

The calculations function is responsible for performing the entire sequence of calculations listed at the end of the mathematical formulation. After setting a range of values for the coolant flow rate, it can perform steps 2 through 12 by simply calling the response function. Then it can use the results to make the graphs requested in the assignment.

:::

**Calculations Function**

The calculations function is created with the following structure:

* It takes no arguments.
* It sets a range of values of $\dot{m}_{ex}$.
* It calls the response function to get the quantities of interest.
* It checks whether $r_{Z,net}$ passes through a maximum within the range of values of $\dot{m}_{ex}$.
	* If it does not pass through a maximum, reports that a maximum was not found and suggests repeating the calculations using a broader range of values of $\dot{m}_{ex}$.
	* If $r_{Z,net}$ does pass through a maximum, it reports the optimum coolant flow rate and the maximum net rate, plots and displays $f_A\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$ *vs*. $t$ and $T\left(t\right)\Big\vert_{\dot{m}_{ex,opt}}$ *vs*. $t$, and saves the results to one or more files.

**Performing the Calculations**

After creating the response function and calculations function as described, all of the calculations needed to complete the assignment can be performed by executing the calculations function. (If the calculations function reports that a maximum was not fould, the range of values of $\dot{m}_{ex}$ must be broadened, and the calculations function executed again.)

**Results**

```{r}
#| echo: false
#| output: false
df <- read.csv(paste0(path_to_results,'reb_13_4_results.csv'))
```

The net rate of production of Z is plotted as a function of the cooling water flow rate in @fig-example_13_4_net_rate_plot. The maximum net rate, `r df$value[1]` `r df$units[1]`, occurs at a coolant flow rate of `r df$value[2]` `r df$units[2]`. The conversion and reacting fluid temperature profiles at that coolant flow rate are shown in @fig-example_13_4_conversion_profile and @fig-example_13_4_temperature_profile.

Knowing the initial concentration of A and the Arrhenius parameters, the conversion and temperature profiles were used to calculate the instantaneous reaction rate profile shown in @fig-example_13_4_rate_profile, where the rate scale is logarithmic.

![Net rate of production of Z as cooling water flow rate varies.](`r paste0(path_to_figures,'reb_13_4_net_rate_plot.png')`){#fig-example_13_4_net_rate_plot width="80%"}

![Conversion profile during processing with the optimum coolant flow rate.](`r paste0(path_to_figures,'reb_13_4_conversion_profile.png')`){#fig-example_13_4_conversion_profile width="80%"}

![Temperature profile during processing with the optimum coolant flow rate.](`r paste0(path_to_figures,'reb_13_4_temperature_profile.png')`){#fig-example_13_4_temperature_profile width="80%"}

![Instantaneous reaction rate profile during processing with the optimum coolant flow rate.](`r paste0(path_to_figures,'reb_13_4_rate_profile.png')`){#fig-example_13_4_rate_profile width="80%"}

**Summary and Comments**

The optimum coolant flow rate is `r df$value[2]` `r df$units[2]`. At that coolant flow rate, the net rate of production of Z is `r df$value[1]` `r df$units[1]`. The conversion of A and reacting fluid temperature during processing at the optimum coolant flow rate are shown in Figures [-@fig-example_13_4_conversion_profile] and [-@fig-example_13_4_temperature_profile].

@fig-example_13_4_net_rate_plot shows that the rate effectively zero when the reactant is charged to the BSTR. @fig-example_13_4_temperature_profile shows the steam heating increases the temperature to 50 °C in ca. 2.5 min, at which time the rate has become significant. The temperature continues to rise because heat is being released by reaction faster than it is being removed by the coolant. As the reactant is depleted, the rate does not increase as rapidly until eventually, after ca. 31.1 min, the rate reaches its maximum value. As the rate decreases, the amount of heat released due to reaction decreases until, at ca. 31.5 min, it becomes equal to the rate at which the coolant is removing heat. At that point the temperature passes through a maximum. After that the coolant removes heat faster than it is generated, and after ca. 100 min the temperature reaches 25 °C and processing ends. The conversion at this point is over 99%.

:::{.callout-note collapse="false"}
## Note

In this example, the net rate of reaction was maximized with respect to the cooling water flow rate. It might be possible to improve the process further by adjusting both the cooling water flow rate *and* the temperature where the heating coil is removed. If that were done, the graphical approach used here to maximize the net rate would not be the best mathematical approach. Instead, a reaction engineer might use software designed for multivariable optimization.

:::

## Symbols Used in @sec-4_bstr_analysis

| Symbol | Meaning |
|:-------|:--------|
| $i$ | index denoting a reagent. |
| $n_i$ | molar amount of reagent $i$, an additional subscripted 0 denotes the initial molar amount. |
| $r_{i,net}$ | net rate of generation of reagent $i$. |
| $t_{rxn}$ | length of time during which reaction occurs. |
| $t_{turn}$ | turnaround time. |

: {tbl-colwidths="[20,80]"}
